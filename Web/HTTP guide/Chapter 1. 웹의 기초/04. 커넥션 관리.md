- HTTP 명세는 HTTP 커넥션과 HTTP 메시지의 흐름에 대한 내용은 충분히 다루고 있지 않음
- HTTP 애플리케이션을 개발하고 있다면 HTTP 커넥션에 대해 잘 이해해야 함
- HTTP 커넥션 관리는 실험이나 시행착오를 통해서 많은 것을 배울 수 있는 마술 같은 기술

<br>

## 1. TCP 커넥션

- 전 세계 모든 HTTP 통신은 패킷 교환 네트워크 프로토콜들의 계층화된 집합인 TCP/IP를 통해 이루어짐
- 세계 어디서든 클라이언트 애플리케이션과 서버 애플리케이션은 TCP/IP 커넥션을 맺을 수 있음
- 일단 커넥션이 맺어지면 주고받는 메시지들은 손실되거나 손상되거나 순서가 뒤바뀌거나 하지 않고 안전하게 전달됨

![TCP IP 커넥션](https://user-images.githubusercontent.com/75058239/196821618-3b8bbb21-8bdf-405b-b268-dff12df2a4f8.png)

### 1.1 신뢰할 수 있는 데이터 전송 통로인 TCP

- HTTP 커넥션에서 몇몇 사용 규칙을 빼면 TCP 커넥션이나 다름 없음
- 신속 정확하게 데이터를 보내고자 한다면 TCP의 기초적인 내용을 알아야 함
- TCP는 HTTP에게 신뢰할 만한 통신 방식을 제공
- TCP 커넥션 상에서 byte들은 순서에 맞게 정확하게 전달됨

### 1.2 TCP 스트림은 세그먼트로 나뉘어 IP 패킷을 통해 전송된다

- TCP는 IP 패킷이라 불리는 작은 조각을 통해 데이터를 전송함

![HTTP HTTPS 네트워크 프로토콜 스택](https://user-images.githubusercontent.com/75058239/196821631-f9864cef-fbb4-4337-8ea1-2f97fb29b4b1.png)

- HTTP는 메시지를 전송할 때 연결되어 있는 TCP 커넥션을 통해서 메시지의 내용을 순서대로 보냄
- TCP는 세그먼트라는 단위로 스트림을 잘게 나누고, 세그먼트를 IP 패킷이라 불리는 봉투에 담아서 전달함
- 위 과정은 TCP/IP 소프트웨어에 의해 처리되며, 그 과정은 HTTP 프로그래머에게 보이지 않음
- 각 TCP 세그먼트는 하나의 IP 주소에서 다른 IP 주소로 IP 패킷에 담겨 전달되며 다음 요소들을 포함함
  - IP 패킷 헤더 (보통 20byte)
    - 발신지, 목적지 IP 주소, 크기, 기타 플래그를 가짐
  - TCP 세그먼트 헤더 (보통 20byte)
    - TCP 포트 번호, TCP 제어 플래그, 데이터 순서 무결성 검사를 위한 숫자 값
  - TCP 데이터 조각 (0 이상의 byte)

![IP 패킷](https://user-images.githubusercontent.com/75058239/197070500-5b777778-c408-4509-9d38-3d43ff521e47.png)

### 1.3 TCP 커넥션 유지하기

- 컴퓨터는 항상 TCP 커넥션을 여러 개 가지고 있고, TCP는 포트 번호를 통해서 커넥션을 유지함
- 포트 번호는 회사 직원의 내선전화와도 같음
  - 대표 전화번호는 안내 데스크로 연결되고 내선전화는 직원에게 연결되듯,<br>IP 주소는 해당 컴퓨터에 연결되고 포트 번호는 해당 애플리케이션으로 연결됨
- TCP 커넥션은 4가지 값으로 식별함

```
<발신지 IP 주소, 발신지 포트, 수신지 IP 주소, 수신지 포트>
```

- 위 값들로 유일한 커넥션을 생성함

### 1.4 TCP 소켓 프로그래밍

- 운영체제는 TCP 커넥션의 생성과 관련된 여러 기능을 제공함
- 소켓 API는 HTTP 프로그래머에게 TCP와 IP의 세부사항들을 감춰주고 주요 인터페이스를 보여줌
  - 유닉스 운영체제용으로 먼저 개발되었지만 지금은 대부분의 운영체제와 프로그래밍 언어에서 사용 가능

|         소켓 API 호출          | 설명                                                   |
| :----------------------------: | :----------------------------------------------------- |
|   `s = socket(<parameters>)`   | 연결되지 않은 익명의 새 소켓 생성                      |
|   `bind(s, <local IP:port>)`   | 소켓에 로컬 포트 번호와 인터페이스 할당                |
| `connect(s, <remote IP:port>)` | 로컬 소켓과 원격 호스트 및 포트 사이에 TCP 커넥션 생성 |
|        `listen(s, ...)`        | 로컬 소켓에서의 커넥션 허용                            |
|        `s2 = accept(s)`        | 로컬 포트에 커넥션이 맺어지기를 기다림                 |
|    `n = read(s, buffer, n)`    | 소켓으로부터 버퍼에 n byte 읽기 시도                   |
|   `n = write(s, buffer, n)`    | 소켓으로부터 버퍼에 n byte 쓰기 시도                   |
|           `close(s)`           | TCP 커넥션 완전 끊기                                   |
|     `shutdown(s, <side>)`      | TCP 커넥션 입출력만 닫음                               |
|      `getsockopt(s, ...)`      | 내부 소켓 설정 옵션값 읽기                             |
|      `getsockopt(s, ...)`      | 내부 소켓 설정 옵션값 변경                             |

- 소켓 API를 사용하면 TCP endpoint 데이터 구조를 생성하고, 원격 서버의 TCP endpoint에<br>생성된 endpoint를 연결해서 데이터 스트림을 읽고 쓸 수 있음
- TCP API는 기본적인 네트워크 프로토콜의 핸드셰이킹, TCP 데이터 스트림,<br>IP 패킷 간 분할 및 재조립에 대한 모든 세부사항을 외부로부터 숨겨줌

![TCP socket interface](https://user-images.githubusercontent.com/75058239/197070460-bcbb93f1-9465-4cdb-9b62-40c95e585d95.png)
