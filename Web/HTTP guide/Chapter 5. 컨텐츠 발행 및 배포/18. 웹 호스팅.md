- 다양한 종류의 리소스를 웹 사이트에 편하게 배포하거나, 웹 서버에 배치하는 것은 매우 중요
- **웹 호스팅**: 컨텐츠 리소스를 저장, 중개, 관리하는 일
- 이번 장에서는 웹 호스팅 서비스의 속성들과, HTTP 애플리케이션과의 상호작용 방식에 대해 다룰 것
  - 여러 웹 사이트를 같은 서버에 '가상 호스팅'하는 방법, 가상 호스팅이 HTTP에 미치는 영향
  - 트래픽이 많은 상황에서 안정적인 사이트를 구축하는 방법
  - 웹 사이트 로딩을 더 빠르게 하는 방법

<br>

## 1. 호스팅 서비스

- 웹의 발전에 따라 서버실, 도메인 이름, 네트워크 대역폭 등을 관리해주는 웹 호스팅 서비스가 많아졌음
- 웹 서버 호스팅의 지원 범위는 제각기 다름
  - 예를 들어 웹 사이트는 다국어와 전자상거래 트랜잭션 보안 지원이 필요할 수도 있음

<br>

## 2. 가상 호스팅

- 많은 사람이 자기만의 웹 공간을 가지고 싶어 하지만, 한 달에 수백 달러 비용이 드는 전용 웹 서버를 가지는 것은 낭비
- **가상 호스팅**: 컴퓨터 한 대를 여러 고객이 공유하게 해서 저렴하게 제공하는 웹 호스팅 서비스
- 사용자 관점에서 가상 호스트 상의 웹 사이트는 물리적으로 분리된 전용 서버 호스팅과 구분할 수 없어야 함
- 가상 호스팅 업자들은 서버 팜을 구축해서 부하를 분산
  - 팜에 있는 각 서버는 다른 서버를 복제한 것
  - 수많은 가상 웹 사이트를 호스팅할 수 있게 됨

### 2.1 호스트 정보가 없는 가상 서버 요청

- HTTP/1.0에서는 Host 헤더가 없기 때문에,<br>사용자가 어떤 가상 웹 사이트로 접근하는지에 대한 정보가 충분하지 않음
- 리버스 프록시와 인터셉트 프록시 또한 이 호스트에 대한 정보가 필요!

## 2.2 가상 호스팅 동작하게 하기

- HTTP/1.0 때는 완전 URL로 요청하게 해서 가상 호스팅이 동작하도록 했음
- HTTP/1.1 또한 완전 URL을 처리할 수 있어야 하지만 기존의 모든 애플리케이션이 명세에 맞춰 업그레이드할 필요가 있음
- 이에 따라 4가지 기술이 등장

**URL 경로를 통한 호스팅**

- URL에 특별한 경로 컴포넌트 추가
- 예시
  - http://www.joes-hardware.com/joe/index.html
  - http://www.joes-hardware.com/mary/index.html
- URL 중간에 끼어야 하는 접두어는 불필요하고 혼란스러움
- 접두어가 안 붙어있는 기본 URL을 활용할 수도 없게 됨
- 좋지 않은 방법이기 때문에 거의 사용되지 않음

**포트번호를 통한 가상 호스팅**

- 서버에서 각 사이트에 다른 포트번호를 할당
- 사용자는 비표준 포트를 사용하지 않고서도 리소스를 찾길 원하기 때문에 역시 좋은 방법이 아님

**IP 주소를 통한 가상 호스팅**

- 각 가상 사이트에 별도의 IP 주소 할당
- 모든 IP 주소는 장비 하나에 연결됨
- 서버는 HTTP 커넥션의 목적지 IP 주소를 보고 클라이언트가 어떤 웹 사이트에 연결하려는지 알 수 있음
- 꽤 좋은 방법이지만 규모가 아주 큰 호스팅 업체라면 어려운 문제가 있음
  - 일반적으로 컴퓨터 시스템이 연결할 수 있는 장비의 IP 개수에는 제한이 있음
  - IP 주소는 희소 상품
- 이러한 IP 주소 부족 문제에도 불구하고 널리 쓰이고 있는 방식

**Host 헤더를 통한 가상 호스팅**

- 웹 서버가 Host 헤더를 통해 가상 사이트를 식별할 수 있게 함
- HTTP/1.1 명세를 따르려면 Host 헤더를 반드시 기술해야 함

### 2.3 HTTP/1.1 Host 헤더

- RFC 2068에 정의되어 있는 HTTP/1.1 요청 헤더
- 가상 서버가 매우 흔하기 때문에 대부분의 클라이언트가 HTTP/1.1 호환이 안 되더라도 Host 헤더는 구현하고 있음

**_문법과 사용 방법_**

```http
Host: www.joes-hardware.com
```

- 요청 리소스에 대한 인터넷 호스트와 포트번호 기술
- 규칙
  - 포트가 명시되어 있지 않으면 scheme의 기본 포트 사용
  - URL에 IP 주소가 있으면 Host 헤더에도 포함해야 함
  - URL에 호스트 명이 있으면 Host 헤더에도 포함해야 함
  - URL에 호스트 명이 있으면 Host 헤더에는 해당 호스트 명을 가리키는 IP 주소가 있으면 안됨
    - 여러 개의 가상 사이트를 한 개의 IP 주소에 연결한 가상 호스팅 서버일 수도 있기 때문
  - 프록시가 아닌 원 서버의 호스트 명과 포트를 기술해야 함
  - 웹 클라이언트는 모든 요청에 Host 헤더를 기술해야 함
  - 웹 프록시는 요청 전달 전에 Host 헤더를 추가해야 함
  - HTTP/1.1 웹 서버는 Host 헤더 필드가 없는 HTTP/1.1 요청에 대해 400 코드로 응답해야 함

**_Host 헤더의 누락_**

- 가상 호스팅 서버가 Host 헤더를 받지 못했을 때는 사용자를 기본 페이지로 보내거나 업그레이드를 제안하는 에러 페이지 반환
- 요즘에는 모든 주요 브라우저가 Host 헤더를 전송

**_Host 헤더 해석하기_**

- Host를 기준으로 리소스를 구분하는 모든 웹 서버는 다음 규칙을 사용해야 함
  - 요청 메시지에 전체 URL이 기술되어 있으면 Host 헤더 무시
  - 요청이 전체 URL이 아니면서, Host 헤더가 있다면, 호스트 명과 포트를 Host 헤더에서 가져옴
  - 둘 다 아니라면, 400 Bad Request 응답 반환

**_Host 헤더와 프록시_**

- 오래되거나 잘못된 브라우저는 원 서버의 Host가 아닌 프록시의 Host를 보내서 골칫거리가 되기도 함

<br>

## 3. 안정적인 웹 사이트 만들기

- 웹 사이트에 장애가 생기는 일반적인 상황들
  - 서버 다운
  - 트래픽 폭증
  - 네트워크 장애 및 손실
- 이 절에서는 위 문제들을 예측하고 대응하는 몇 가지 방법에 대해 다룰 것

### 3.1 미러링 된 서버 팜

- 서버 팜: 서로 대신할 수 있고 식별할 수 있도록 설정된 웹 서버들의 집합
- 서버 한 곳에 문제가 생기면 다른 곳에서 대신 전달할 수 있도록 미러링 가능
- 보통 계층적인 관계를 가지며, 따라서 마스터 원 서버와 복제 원 서버로 나뉘게 됨
- 서버 팜을 이루는 간단한 방법: 네트워크 스위치를 사용해서 서버에 분산 요청을 보내는 것
  - 서버에 호스팅되고 있는 각 웹 사이트의 IP 주소는 스위치의 IP 주소가 됨
  - 스위치는 서버에게 요청을 전송해야 하는 책임이 있음
- 마스터 원 서버는 클라이언트에게 컨텐츠를 제공하면서 복제 서버들에게 컨텐츠를 퍼트림

※ 클라이언트의 요청이 특정 서버로 가는 2가지 방법

**HTTP 리다이렉션**

- 컨텐츠에 대한 URL은 마스터 서버의 IP를 가리키고, 마스터 서버는 요청을 받는 즉시 복제 서버로 리다이렉트

**DNS 리다이렉션**

- 컨텐츠 URL은 여러 개의 IP 주소를 가리키고, DNS 서버가 클라이언트에게 전송할 IP 주소 선택

### 3.2 컨텐츠 분산 네트워크 (CDN)

- 특정 컨텐츠의 분산을 목적으로 하는 단순한 네트워크
- 네트워크의 노드는 서버, 대리 서버, 프록시 서버가 될 수 있음

### 3.3 CDN의 대리 캐시

- 리버스 프록시라고도 불리는 대리 서버는 원 서버 집합을 대신해서 요청을 받음
- 대리 서버와 미러링 된 서버의 차이점: **대리 서버는 수요에 따라서 동작**
  - 원 서버의 전체 컨텐츠를 복사하지 않고, 클라이언트가 요청하는 컨텐츠만 저장
  - 사용자가 요청하기도 전에 컨텐츠를 가져오는 '미리 가져오기' 기능을 가진 대리 서버도 있음
  - CDN은 미러링 서버보다 캐시를 계층화하기가 어려움

### 3.4 CDN의 프록시 캐시

- 대리 서버와 다르게 프록시 캐시는 어떤 웹 서버 요청이든 다 받을 수 있음
- 대리 서버를 사용하면 프록시 캐시의 컨텐츠는 요청이 있을 때만 저장되고 원본 서버 컨텐츠를 정확히 복제한다는 보장이 없음
- 요청이 있을 때만 저장하는 프록시 캐시의 작동 방식은 조금 다름
  - Layer 2 혹은 Layer 3 장비(스위치 혹은 라우터)가 중간에서 웹 트래픽을 가로채서 처리하기도 함
- 가로채기 설정은 클라이언트와 서버 사이의 모든 HTTP 요청이 물리적으로 캐시를 거치도록 네트워크 설정이 되어있는지에 따라 다름

<br>

## 4. 웹 사이트 빠르게 만들기

- 서버 팜, 분산 프록시 캐시, 대리 서버는 혼잡을 조절하고 네트워크 트래픽을 분산시켜 줌
- 컨텐츠를 분산시키면 사용자게에 더 가깝게 만들 수 있으므로 컨텐츠 전송 시간을 단축할 수 있음
- 웹 사이트 속도를 높이는 또 다른 방법: 컨텐츠 인코딩
  - 컨텐츠 압축 등
