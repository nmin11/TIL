- HTTP는 오직 출발지와 목적지를 고려하지만 미러링된 서버, 웹 프록시, 캐시를 거쳐야 하기 때문에 단순하지 않음
- 리다이렉션 기술 → HTTP 메시지의 최종 목적지를 결정하는 네트워크 도구, 기법, 프로토콜
- 리다이렉션 기술은 보통 메시지가 프록시, 캐시, 서버 팜의 특정 웹 서버 중 어디에서 끝났는지 판별하기 위해 사용
- 리다이렉션 기술은 클라이언트의 메시지를 명시적으로 요청하지 않은 곳으로 보낼 수 있음
- 이번 장에서 배울 키워드들
  - HTTP 리다이렉션
  - DNS 리다이렉션
  - 임의 캐스트 라우팅
  - 정책 라우팅
  - IP 맥 포워딩
  - IP 주소 포워딩
  - WCCP (웹 캐시 조직 프로토콜)
  - ICP (인터캐시 커뮤니케이션 프로토콜)
  - HTCP (하이퍼텍스트 캐싱 프로토콜)
  - NECP (네트워크 요소 제어 프로토콜)
  - CARP (캐시 배열 라우팅 프로토콜)
  - WPAD (웹 프록시 자동발견 프로토콜)

<br>

## 1. 왜 리다이렉트인가?

- HTTP 애플리케이션이 언제나 원하는 3가지
  - 신뢰할 수 있는 HTTP 트랜잭션 수행
  - 지연 최소화
  - 네트워크 대역폭 절약
- 이를 보장하기 위해 흔히 웹 컨텐츠는 여러 장소에 배포됨
  - 한 곳의 장애에도 대응 가능
  - 보다 가까운 리소스에 접근 가능
  - 네트워크 혼잡도 줄어듦
- 리다이렉션: 최적의 분산된 컨텐츠 탐색을 도와주는 기법의 집합
- 리다이렉션 구현에는 부하 균형 과제가 함께 딸려옴
  - 대부분의 리다이렉션 장치들은 몇 가지 방식의 부하 균형을 포함
  - 마찬가지로 부하 균형 또한 어떤 식으로든 부하를 공유하는 서버들 중 하나에 리다이렉션되어야 함

<br>

## 2. 리다이렉트 할 곳

- 서버, 프록시, 캐시, 게이트웨이는 모두 공통적으로 서버의 특성을 갖고 있음
  - 많은 리다이렉션 기법이 이들 모두에서 동작
- 그러나 특정 종류의 종단만을 위해 특별히 설계된 기법들이 따로 있음 (나중 배울 내용)
- 웹 서버는 IP별로 요청을 다룸
  - 요청을 분산한다는 것은 같은 URL에 대한 각 요청을 최적의 웹 서버로 보내겠다는 뜻
- 프록시는 프로토콜별로 요청을 다룸
  - 이상적으로 프록시 이웃의 모든 HTTP 트래픽은 프록시를 거쳐야 함 (통신 비용 절약)
  - 프록시로의 리다이렉트는 주 진입로의 트래픽을 지름길로 빨아들이는 것

<br>

## 3. 리다이렉션 프로토콜의 개요

- 리다이렉션의 목표: HTTP 메시지를 가용한 웹 서버로 가급적 빨리 보내는 것
  - 메시지가 오가는 라우팅 장치에 영향을 받게 됨
- 메시지를 리다이렉트하는 메커니즘들: 브라우저 설정, DNS, TCP/IP 라우팅, HTTP

|                메커니즘                 | 작동 방식                                                   | 재 라우팅 근거                                           | 제약사항                                                |
| :-------------------------------------: | :---------------------------------------------------------- | :------------------------------------------------------- | :------------------------------------------------------ |
|             HTTP 리다이렉션             | 첫 번째 웹 서버에서 리다이렉트를 선택하게 함                | 라운드 로빈 부하 균형, latency 최소화, 최단 거리 선정 등 | 모든 트랜잭션이 추가 리다이렉트를 포함할 수 있음        |
|             DNS 리다이렉션              | DNS 서버가 어떤 IP 주소를 사용할지 결정                     | 라운드 로빈 부하 균형, latency 최소화, 최단 거리 선정 등 | DNS 서버 설정 필요                                      |
|          임의 캐스트 어드레싱           | 여러 서버가 같은 IP 주소 사용                               | 라우터들은 내장된 최단거리 라우팅 기능 사용              | 라우터 설정 필요, 주소 충돌 위험                        |
|              IP MAC 포워딩              | 스위치, 라우터 등 네트워크 요소가 패킷의 목적지 주소를 읽음 | 대역폭 절약, QOS(Quality of Service) 개선                | 서버나 프록시는 반드시 한 홉 거리에 있을 것             |
|             IP 주소 포워딩              | 스위치가 패킷의 목적지 포트 평가                            | 대역폭 절약, QOS 개선                                    | 서버나 프록시가 클라이언트의 IP 주소를 잃어버릴 수 있음 |
|          명시적 브라우저 설정           | 웹 브라우저가 가까운 프록시에게 HTTP 메시지를 보내도록 설정 | 대역폭 절약, QOC 개선                                    | 브라우저 설정 능력에 의존                               |
|     PAC (Proxy Auto-Configuration)      | 웹 브라우저가 설정 서버로부터 PAC 파일 검색                 | 대역폭 절약, QOC 개선                                    | 브라우저가 설정 서버에 질의를 보낼 수 있을 것           |
| WPAD (Web Proxy Autodiscovery Protocol) | 웹 브라우저가 설정 서버에게 PAC 파일에 대한 URL 질의        | 설정 서버가 URL 결정                                     |                                                         |
| WCCP (Web Cache Coordination Protocol)  | 라우터가 패킷의 목적지 주소를 평가                          | 대역폭 절약, QOC 개선                                    | 브라우저가 반드시 WCCP를 지원해야 함                    |
|      ICP (Internet Cache Protocol)      | 프록시 캐시가 형제 캐시에게 요청 받는 컨텐츠에 대해 질의    | 캐시를 통해 원 서버보다 빠르게 얻어냄                    | 캐시 적중이 아닐 수도 있게 됨                           |
|   CARP (Cache Array Routing Protocol)   | 캐시 컨텐츠 분산                                            | 캐시를 통해 원 서버보다 빠르게 얻어냄                    | CARP 설정에 동의할 것                                   |
|   HTCP (Hyper Text Caching Protocol)    | 프록시 캐시가 형제 캐시에게 요청 받는 컨텐츠에 대해 질의    | 캐시를 통해 원 서버보다 빠르게 얻어냄                    |                                                         |

<br>

## 4. 일반적인 리다이렉션 방법

### 4.1 HTTP 리다이렉션

- 몇몇 웹 사이트는 HTTP 리다이렉션을 이용해서 간단하게 부하를 분산
- 서버가 직접 가용한 것들 중 부하가 가장 적은 컨텐츠 서버를 찾아서 리다이렉트
- 웹 서버가 광범위하게 분산되어 있다면 '최선의' 가용 서버를 결정하는 것이 까다로움
  - 서버 부하
  - 인터넷 상에서의 브라우저와 서버 간의 거리도 계산해야 함
- 장점
  - 리다이렉트하는 서버가 클라이언트의 IP 주소를 알고 있어서, 정보에 근거한 판단을 내릴 수 있음
- 단점
  - 어떤 서버로 리다이렉트할지 결정하기 위해 원 서버는 상당히 많은 처리를 하게 됨
  - 사용자는 페이지에 접근할 때마다 2번의 왕복 필요
  - 리다이렉트 서버가 고장나면 사이트도 고장남
- 이러한 약점 때문에 HTTP 리다이렉션은 보통 몇몇 다른 리다이렉션 기법과 함께 조합해서 사용됨

### 4.2 DNS 리다이렉션

- DNS 분석자가 될 수 있는 것들
  - 클라이언트의 운영체제
  - 클라이언트의 네트워크에 있는 DNS 서버
- DNS는 하나의 도메인에 여러 IP 주소가 결부되는 것을 허용
- DNS 분석자는 여러 IP 주소를 반환하도록 설정하거나 프로그래밍할 수 있음

※ 라운드 로빈 - 가장 쉬운 DNS 결정 알고리듬

(이미지 첨부 - DNS 기반 리다이렉션)

**_DNS 라운드 로빈_**

- 웹 서버 팜 전체에 대한 부하 균형 유지를 위해 DNS 호스트 명 분석 기능 사용
- 클라이언트의 상대적 위치나 서버의 스트레스 상태를 고려하지 않음

**_다중 주소와 라운드 로빈 주소 순환_**

- 대부분의 DNS 클라이언트는 그냥 다중 주소 집합의 첫 번째 주소 사용
- 부하 균형을 위해서 룩업이 끝날 때마다 주소를 순환

**_DNS 캐싱의 효과_**

- 하지만 DNS 룩업의 결과는 애플리케이션, 운영체제 등 자식 DNS 서버에 의해 기억되고 재사용될 수 있음
  - 한 번의 DNS 룩업을 하고, 그 주소를 몇 번이고 다시 사용
  - DNS 룩업 비용을 줄일 수 있기 때문
  - 같은 클라이언트와 계속 대화하는 것을 선호하는 서버들도 있기 때문
- 그렇기 때문에 DNS 라운드 로빈은 일반적으로 하나의 클라이언트로 인한 부하를 제대로 분산하지 못함
- 그래도 나름 여러 클라이언트의 부하 총량을 분산하는 적절한 작업은 수행
  - 클라이언트 수가 어느 정도 이상만 되면, 부하는 모든 서버에 걸쳐 나름대로 잘 분산될 것

**_다른 DNS 기반 리다이렉션 알고리듬_**

- 부하 균형 알고리듬: 웹 서버 로드를 추적해서 가장 로드가 적은 웹 서버를 목록 최상위에 둠
- 근접 라우팅 알고리듬: 서버 팜이 지리적으로 분산되어 있을 때, 사용자를 근처의 웹 서버로 보냄
- 결함 마스킹 알고리듬: 네트워크 건강 상태를 모니터링해서 장애를 피하는 라우팅

※ authoritative server

(이미지 첨부 - 권위 있는 DNS 서버)

- 컨텐츠 제공자의 통제하에 있는 권위 있는 서버를 사용하는 방식
- 인접한 서버를 찾는 서비스들을 위한 모델
- 단점: 권위 있는 서버가 결정을 내리기 위해 사용하는 유일한 정보가 클라이언트의 IP 주소가 아닌 로컬 DNS 서버의 IP 주소

### 4.3 임의 캐스트 어드레싱

- 지리적으로 흩어져 있는 웹 서버들이 동일한 IP 주소를 가짐
- 클라이언트의 요청을 가장 가까운 서버로 보내주기 위해 백본 라우터의 '최단거리' 라우팅 능력에 의존
- 방식 중 하나: 라우터 스스로가 웹 서버에게 인접한 백본 라우터를 향하는 라우터라고 광고하게 하는 것
  - 백본 라우터는 패킷을 받고 해당 IP 주소와 가장 가까운 라우터를 탐색
  - 라우터는 스스로 어떤 주소를 위한 라우터인지 광고한 상태이기 때문에, 백본 라우터는 해당 라우터에게 패킷을 전송
- 임의 캐스트 어드레싱은 여전히 실험적인 기법
  - 서버는 반드시 '라우터의 언어'로 말해야 함
  - 인터넷 주소는 기본적으로 한 서버에 하나임을 가정하기 때문에 주소 충돌을 반드시 다룰 수 있어야 함
    - route leaks로 알려진 심각한 문제를 유발할 수 있는 요인
- 백본 네트워크를 제어하는 컨텐츠 제공자들을 위한 하나의 솔루션 정도로 기억해둘 것

### 4.4 IP MAC 포워딩

- 이더넷 네트워크에서, HTTP 메시지는 주소가 붙은 데이터 패킷 형식
- 각 패킷은 출발지, 목적지, IP 주소, TCP 포트번호로 이루어진 Layer 4 구조
- 각 패킷은 또한 Layer 2 장비가 주목하는 주소인 MAC(Media Access Control) 주소도 가짐
  - Layer 2 장비는 특정 MAC 주소의 패킷을 받아서 특정 MAC 주소로 포워딩하는 것
- 스위치는 Layer 4 주소를 검사해서 라우팅할 수 있음
  - 예시: 80번 포트로 향하는 모든 웹 트래픽을 프록시로 보낼 수 있음
    - 여기에서 캐시 신선도를 검사하고 요청을 원 서버에 보내야 할지 결정할 수도 있는 것
- MAC 포워딩을 지원하는 Layer 4 스위치는 보통 여러 프록시 캐시를 활용해서 부하 균형을 유지
- hop-by-hop 만 가능하기 때문에 서버나 프록시는 스위치와 한 홉 거리에 있어야 함

### 4.5 IP 주소 포워딩

- Layer 4를 이해하는 장비는 들어오는 패킷에 대해 TCP/IP 어드레싱 검증 후 목적지 IP 주소 변경에 따라 라우팅
  - MAC 포워딩보다 좋은 점: 목적지 서버가 한 홉 거리에 있을 필요 X
- 그저 스위치에서 업스트림 위치 판별이 가능하면 일반적인 Layer 3 end-to-end 라우팅이 됨
- NAT(Network Address Translation)라고도 불림
- 그러나 **라우팅 대칭성** 문제가 있음
  - TCP 커넥션을 받는 스위치는 커넥션을 통해 반드시 응답을 돌려주어야 함
  - 그러므로 모든 응답은 반드시 스위치에게 돌아가야 함
- 응답의 귀환 경로 제어 방법
  - 패킷의 출발지 IP 주소를 스위치의 IP 주소로 변경
    - 스위치와 서버 사이 네트워크 설정과 무관하게 응답 패킷을 스위치로 전송
    - 출발지와 목적지 IP 주소 양쪽을 번역해주는 IP 전달 장치를 완전 NAT라고 부름
    - 클라이언트의 IP 주소를 웹 서버가 알 수 없게 할 수 있음
  - 출발지 IP 주소를 클라이언트 IP 주소로 그대로 남겨둠
    - 서버에서 스위치를 거치지 않고 클라이언트로 바로 가는 경로가 없어야 함
    - half NAT라고도 불림
    - 장점: 서버가 클라이언트의 IP 주소를 얻을 수 있음
    - 단점: 클라이언트와 서버 사이 네트워크 전체에 약간의 통제 필요

### 4.6 NECP (Network Element Control Protocol)

- 라우터, 스위치 등 NE(Network Elements)가 웹 서버, 프록시 캐시 등 SE(Server Elements)와 대화할 수 있게 해줌
- 부하 균형을 명시적으로 지원하지는 않음
  - 다만 SE는 NE에게 부하 균형 정보를 제공하여, SE가 적합하다고 판단한 대로 NE가 부하 균형을 유지할 수 있도록 함
- MAC forwarding, GRE encapsulation, NAT 등 패킷을 전달하는 여러 방법 제공
- 예외 개념 지원
  - SE는 특정 출발지 IP 주소의 서비스 가능 여부 판단 가능
  - 해당 주소들을 NE로 보낼 수 있음
  - 그러면 NE는 해당 IP 주소로부터의 요청을 원 서버에 전달 가능

**_NECP 메시지_**

|          메시지          | 전송 주체 | 의미                                            |
| :----------------------: | :-------: | :---------------------------------------------- |
|        NECP_NOOP         |           | 작업 없음                                       |
|        NECP_INIT         |    SE     | NE와 통신 개시, 반드시 NE 포트를 알고 있어야 함 |
|      NECP_INIT_ACK       |    NE     | 확인했음                                        |
|      NECP_KEEPALIVE      |  NE / SE  | peer가 살아있는지 확인                          |
|    NECP_KEEPALIVE_ACK    |  NE / SE  | keep-alive에 대답                               |
|        NECP_START        |    SE     | 트래픽 받을 준비 완료, 포트 지정 가능           |
|      NECP_START_ACK      |    NE     | 확인했음                                        |
|        NECP_STOP         |    SE     | 트래픽 전송 중단 요청                           |
|      NECP_STOP_ACK       |    NE     | 전송 중단을 알림                                |
|    NECP_EXCEPTION_ADD    |    SE     | NE가 가진 목록에 하나 이상의 예외 추가 요청     |
|  NECP_EXCEPTION_ADD_ACK  |    NE     | 예외 추가 요청 승인                             |
|    NECP_EXCEPTION_DEL    |    SE     | NE가 가진 목록에서 하나 이상의 예외 삭제 요청   |
|  NECP_EXCEPTION_DEL_ACK  |    NE     | 예외 삭제 요청 승인                             |
|   NECP_EXCEPTION_RESET   |    SE     | NE의 예외 목록 전체 삭제 요청                   |
| NECP_EXCEPTION_RESET_ACK |    NE     | 예외 전체 삭제 요청 승인                        |
|   NECP_EXCEPTION_QUERY   |    SE     | NE가 가진 전체 예외 목록 문의                   |
|   NECP_EXCEPTION_RESP    |    NE     | 예외 목록 응답                                  |
