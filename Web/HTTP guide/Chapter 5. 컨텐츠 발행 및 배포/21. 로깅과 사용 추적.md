- 거의 모든 서버 및 프록시는 처리한 HTTP 트랜잭션을 요약해서 기록함
- 사용 추적, 보안, 청구, 에러 탐지 등을 위해서
- 이 장에서 배울 것들
  - 로깅
  - 어떤 HTTP 트랜잭션 정보를 기록하는지
  - 로그 포맷들

<br>

## 1. 로그란 무엇인가?

- 일반적으로 로깅을 하는 2가지 이유
  - 서버나 프록시의 문제 찾기
  - 웹 사이트 접근 통계
- 통계는 마케팅, 청구, 장비 조달 계획을 세우는 데 유용
- HTTP 트랜잭션의 모든 헤더를 로깅할 수도 있지만 감당해야 하는 트랜잭션이 장난이 아닐 수도 있음
- 일반적으로 로깅하는 필드들
  - HTTP 메소드
  - 요청받은 리소스의 URL
  - 클라이언트와 서버의 HTTP 버전
  - 응답의 HTTP 상태 코드
  - 요청과 응답 메시지의 크기
  - 트랜잭션이 일어난 시간
  - Referer와 User-Agent 헤더 값
- HTTP 메소드와 URL은 어떤 요청이 어떤 일을 하려고 했는지 가리킴
- 버전 정보는 문제가 생겼을 때 클라이언트와 서버에 관한 정보를 토대로 디버깅할 수 있게 함
- 요청/응답의 크기와 타임스탬프는 주로 계측을 위해 사용됨
  - 얼마나 많은 byte를 애플리케이션 안팎으로 송수신하는지

<br>

## 2. 로그 포맷

- 이 장에서는 가장 일반적인 몇 가지 포맷만 다룰 것
- 상용 및 오픈 소스 HTTP 애플리케이션은 대부분 표준 로그 포맷을 1개 이상 지원
- 애플리케이션 대부분이 로그 포맷을 설정할 수 있는 기능 제공

### 2.1 Common Log Format

- NCSA가 정의했으며, 대부분의 서버가 이 로그 포맷을 기본으로 사용
- 일반 로그 포맷 파일을 구문 분석하는 수많은 상용 혹은 무료 소프트웨어 도구들이 있음

※ Common Log Format의 필드들

|     필드      | 설명                                               |
| :-----------: | :------------------------------------------------- |
|  remotehost   | 요청한 컴퓨터의 호스트 명 혹은 IP 주소             |
|   username    | ident 검색을 수행했다면, 인증된 요청자 이름이 있음 |
| auth-username | 인증을 수행했다면, 인증된 요청자 이름이 있음       |
|   timestamp   | 요청 날짜와 시간                                   |
| request-line  | HTTP 요청 행을 그대로 기술                         |
| response-code | 응답으로 보내는 HTTP 상태 코드                     |
| response-size | 응답 엔티티의 Content-Length                       |

※ Common Log Format 엔트리의 몇 가지 예

```
209.1.32.44 - - [03/Oct/1999:14:16:00 -0400] "GET / HTTP/1.0" 200 1024
http-guide.com - dg [03/Oct/1999:14:16:32 -0400] "GET / HTTP/1.0" 200 477
http-guide.com - dg [03/Oct/1999:14:16:32 -0400] "GET /foo HTTP/1.0" 404 0
```

### 2.2 Combined Log Format

- 아파치 같은 서버들이 지원하는, 역시 많이들 사용하는 로그 포맷
- Common Log Format과 매우 유사
  - 사실, 추가된 필드 2개를 제외하면 똑같음

|    필드    | 설명                            |
| :--------: | :------------------------------ |
|  Referer   | Referer HTTP 헤더 값            |
| User-Agent | User-Agent Referer HTTP 헤더 값 |

```
209.1.32.44 - - [03/Oct/1999:14:16:00 -0400] "GET / HTTP/1.0" 200 1024 "http://www.joes-hardware.com/" "5.0: Mozilla/4.0 (compatible; MSIE 5.0; Windows 98)"
```

### 2.3 Netscape Extended Log Format

- 넷스케이프는 상용 HTTP 애플리케이션이 되면서 서버의 여러 로그 포맷을 도입했음
- NCSA 일반 로그 포맷 바탕으로, 프록시나 웹 캐시 등 HTTP 애플리케이션과 연관된 여러 환경을 지원하고자 확장
- 넷스케이프 확장 로그 포맷의 앞부분 7개 필드는 Common Log Format과 동일

※ 넷스케이프 확장 로그 포맷에서 추가된 필드들

|           필드           | 설명                                                                |
| :----------------------: | :------------------------------------------------------------------ |
|   proxy-response-code    | 프록시를 거쳤을 때, 서버에서 프록시로의 HTTP 응답 코드              |
|   proxy-response-size    | 프록시를 거쳤을 때, 서버에서 프록시로의 Content-Length              |
|   client-request-size    | 클라이언트가 프록시로 보내는 Content-Length                         |
|    proxy-request-size    | 프록시를 거쳤을 때, 프록시에서 서버로의 Content-Length              |
| client-request-hdr-size  | 클라이언트 요청 헤더의 byte 길이                                    |
| proxy-response-hdr-size  | 프록시를 거쳤을 때, 프록시에서 클라이언트로의 응답 헤더 byte 길이   |
|  proxy-request-hdr-size  | 프록시를 거쳤을 때, 프록시에서 서버로의 요청 헤더 byte 길이         |
| server-response-hdr-size | 서버 응답 헤더 byte 길이                                            |
|     proxy-timestamp      | 프록시를 거쳤을 때, 요청과 응답이 프록시를 통해 오가는 총 시간(sec) |

```
209.1.32.44 - - [03/Oct/1999:14:16:00 -0400] "GET / HTTP/1.0" 200 1024 200 1024 0 0 215 260 279 254 3
```

### 2.4 Netscape Extended-2 Log Format

- HTTP 프록시와 웹 캐시 애플리케이션과 관련된 더 많은 정보 포함
- 추가된 필드들을 통해 HTTP 클라이언트와 HTTP 프록시 애플리케이션 간의 통신 설계에 도움을 줌

|           필드            | 설명                                                        |
| :-----------------------: | :---------------------------------------------------------- |
|           route           | 프록시가 클라이언트에 요청을 만들기 위해 사용하는 경로      |
| client-finish-status-code | 클라이언트의 종료 상태 코드<br>완료 - FIN / 인터럽트 - INTR |
| proxy-finish-status-code  | 프록시의 종료 상태 코드<br>완료 - FIN / 인터럽트 - INTR     |
|     cache-result-code     | 캐시 결과 코드                                              |

```
209.1.32.44 - - [03/Oct/1999:14:16:00 -0400] "GET / HTTP/1.0" 200 1024 200 1024 0 0 215 260 279 254 3 DIRECT FIN FIN WRITTEN
```

※ Netscape Extended-2 Log Format 필드들이 사용하는 코드들

- route 코드
  - `DIRECT` : 리소스를 서버에서 바로 가져왔음
  - `PROXY(host:port)` : 리소스를 host라는 프록시를 통해 가져왔음
  - `SOCKS(socks:port)` : 리소스를 socks라는 SOCKS 서버를 통해 가져왔음
- 넷스케이프 종료 코드
  - `-` : 요청이 시작되지 않았음
  - `FIN` : 요청이 성공적으로 완료되었음
  - `INTR` : 요청이 클라이언트에 의해 중단되었거나 프록시/서버에 의해 종료되었음
  - `TIMEOUT` : 요청이 프록시/서버의 타임아웃에 걸렸음
- 넷스케이프 캐시 코드
  - `-` : 캐시할 수 없는 리소스
  - `WRITTEN` : 리소스를 캐시에 저장했음
  - `REFRESHED` : 리소스를 캐시했고 갱신했음
  - `NO-CHECK` : 캐시된 리소스를 반환했고 신선도 검사를 하지 않았음
  - `UP-TO-DATE` : 캐시된 리소스를 반환했고 신선도 검사를 완료했음
  - `HOST-NOT-AVAILABLE` : 캐시된 리소스를 반환했고 원 서버에 이상이 있어서 신선도 검사를 하지 않았음
  - `CL-MISMATCH` : Content-Length가 리소스 크기와 맞지 않아서 캐시 저장을 중단했음
  - `ERROR` : 어떠한 에러로 인해 리소스를 캐시에 저장하지 못했음

<br>

- 넷스케이프 애플리케이션은 **Flexible Log Format**을 가지고 있음
  - 관리자는 추가적인 설정으로 로그를 최적화할 수 있음
