# λ‹¨ν•μ„± λ””μ¤ν¨μΉμ™€ μ¨-μ¤νƒ μΉν™ μ•μ•„λ³΄κΈ°

*Mono-Morphic Dispatch & On-Stack Replacement*

β― λ‚¨κ¶λ―Ό

## ν—·κ°λ¦¬λ” κ°λ…λ“¤μ„ κΉμ΄ μ΄ν•΄ν•΄λ³΄μ!

10μ¥μ—μ„ λ‹¤λ£¨λ” ν•«μ¤ν JIT μ»΄νμΌλ¬μ μµμ‹  μµμ ν™” κΈ°λ²•λ“¤

- μΈλΌμ΄λ‹
- λ£¨ν”„ νΌμΉκΈ°
- νƒμ¶ λ¶„μ„
- λ½ μƒλµ/ν™•μ¥
- λ‹¨μΌν• λ””μ¤ν¨μΉ
- μΈνΈλ¦°μ§
- μ¨-μ¤νƒ μΉν™

---

- ~~μΈλΌμ΄λ‹~~ - π‘
- ~~λ£¨ν”„ νΌμΉκΈ°~~ - π‘
- ~~νƒμ¶ λ¶„μ„~~ - π‘
- ~~λ½ μƒλµ/ν™•μ¥~~ - π‘
- λ‹¨μΌν• λ””μ¤ν¨μΉ - *μ΅°κΈ ν—·κ°λ¦¬λ”λ°...*
- ~~μΈνΈλ¦°μ§~~ - π‘
- μ¨-μ¤νƒ μΉν™ - *μ—¥ λ­μ§€?*

## μλ°” λ©”μ†λ“ λ””μ¤ν¨μΉμ ν‘λ§μ 

[The Black Magic of (Java) Method Dispatch](https://shipilev.net/blog/2015/black-magic-method-dispatch/)

### λ©”μ†λ“ λ””μ¤ν¨μΉ λ°©μ‹μ„ μ΄ν•΄ν•΄μ•Ό ν•λ” μ΄μ 

- μλ°”λ” μ¬μ‚¬μ© κ°€λ¥ν• λ¨λ“μ‹ μ†ν”„νΈμ›¨μ–΄ μ‘μ„±μ„ μ„ν•΄ **μ„λΈνƒ€μ…**κ³Ό **λ‹¤ν•μ„±**μ„ μ§€μ›
- κ°€μƒ νΈμ¶μ— λ€ν• ν•λ“μ›¨μ–΄ μ§€μ›μ΄ μ—†μΌλ―€λ΅, **λ©”μ†λ“ λ””μ¤ν¨μΉ**μ—λ” λ‹Ήμ—°ν λ€κ°€κ°€ λ”°λ¦„
- λ€λ¶€λ¶„μ κ²½μ° λ©”μ†λ“ λ””μ¤ν¨μΉμ— λ€ν• μ„±λ¥ μ¤λ²„ν—¤λ“λ” λ¬΄μ‹ν•  μ μμ„ μ •λ„λ΅ μ‘μ
- ν•μ§€λ§ λ©”μ†λ“ λ””μ¤ν¨μΉ μ„±λ¥μ΄ μ¤‘μ”ν• λ‡λ‡ μΌ€μ΄μ¤λ“¤μ΄ μ΅΄μ¬ν•¨

### μ •μ  λ©”μ†λ“, μ¶”μƒ ν΄λμ¤ κµ¬ν„μ²΄, μΈν„°νμ΄μ¤ κµ¬ν„μ²΄

- λ²¤μΉλ§ν¬λ¥Ό ν•΄λ³΄λ©΄ μ •μ  λ©”μ†λ“ - λ™μ  μ¶”μƒ ν΄λμ¤ κµ¬ν„μ²΄ - λ™μ  μΈν„°νμ΄μ¤ κµ¬ν„μ²΄ μμΌλ΅ μ„±λ¥μ΄ λΉ λ¦„
- μ •μ  λ©”μ†λ“λ” **μ •μ  λ°”μΈλ”©**μ„ ν†µν•΄ λ©”μ†λ“ λ””μ¤ν¨μΉλ¥Ό μƒλµν•  μ μμ
- λ™μ  μ¶”μƒ ν΄λμ¤ κµ¬ν„μ²΄λ” κ°€μƒ λ©”μ†λ“λ¥Ό νΈμ¶ν•λ©΄μ„ null check λΉ„μ© λ°μƒ
- λ™μ  μΈν„°νμ΄μ¤ κµ¬ν„μ²΄λ” νƒ€μ… μ²΄ν¬ λΉ„μ©λ„ μ¶”κ°€λ΅ λ°μƒ

### λ‹¨ν•μ„± λ””μ¤ν¨μΉ

- μ»΄νμΌ νƒ€μ„μ— call receiverλ¥Ό μ •ν™•ν μ•κ³  μκ³ , λ©”μ†λ“ λ™μ‘μ΄ receiver μƒνƒμ— μμ΅΄ν•μ§€ μ•λ”λ‹¤λ©΄ `static`μ„ μ‚¬μ©ν•μ

### μ΄ν•μ„± λ””μ¤ν¨μΉ

- ν•μ„ ν΄λμ¤ νΉμ€ μΈν„°νμ΄μ¤ κµ¬ν„μ²΄λ“¤μ€ C2 μ»΄νμΌλ¬μ—μ„ ν›λ¥­ν•κ² μµμ ν™”λλ‹¤
- μΌλ°μ μ΄μ§€ μ•μ€ λ‡λ‡ κ²½μ°μ— λ”°λΌ, μ •μ  λ””μ¤ν¨μΉ λ°©μ‹μΌλ΅ μ•½κ°„μ μ¤λ²„ν—¤λ“λ¥Ό μ¤„μ΄λ” μ„±λ¥ μµμ ν™”λ” κ°€λ¥ν•λ‹¤

### λ‹¤ν•μ„± λ””μ¤ν¨μΉ

- μ •μ  λ¶„μ„μ΄ 3κ°μ νΈμ¶ κ°€λ¥ νƒ€κ²μ„ ν™•μΈν•λ”λΌλ„, μ»΄νμΌλ¬λ” λ™μ  νƒ€μ… ν”„λ΅ν•„μ„ ν™μ©ν• μ¶”μΈ΅μ„± μµμ ν™”λ¥Ό ν†µν•΄ μ •ν™•ν• receiver νƒ€κ²μ„ μ°Ύμ•„λ‚Ό μ μλ‹¤
  - C2λ” λ‹¨ν•μ„± λ° μ΄ν•μ„±μ κ²½μ°μ— μΌλ°μ μΌλ΅ μ΄ μ‘μ—…μ„ μν–‰ν•κ³ , ν™•μ‹¤ν•κ² μ¶”μΈ΅ν•  μ μλ” λ‹¤ν•μ„±μ κ²½μ°μ—λ„ μν–‰ν•λ‹¤
  - C1μ€ λ‹¤ν•μ„± λ””μ¤ν¨μΉ μµμ ν™”λ¥Ό μν–‰ν•μ§€ μ•λ”λ‹¤
- `instanceof` μ—°μ‚°μλ¥Ό μ‚¬μ©ν•λ©΄, μ»΄νμΌλ¬λ” νƒ€μ… μ²΄ν¬λ¥Ό μν–‰ν•κ³ , λ©”μ†λ“ νΈμ¶μ„ μµμ ν™”ν•  μ μλ‹¤
  - λ‹¤ν•μ„±μ„ λ‹¨ν•μ„±, μ΄ν•μ„±μΌλ΅ μΉν™ν•λ” μ…

dynamic method dispatch

- μ–΄λ–¤ λ©”μ†λ“κ°€ νΈμ¶λ μ§€ λ™μ μΌλ΅ κ²°μ •ν•λ” κ²ƒ

## λ‹¨μΌμ„±μ΄ λ­μ•Ό?

[What's up with monomorphism?](https://mrale.ph/blog/2015/01/11/whats-up-with-monomorphism.html)

- λ‹¤ν•μ„±μ λ§¤μ° μ•½ν• λ³΄μ¥
  - "objectλ” A, B, C μ¤‘μ— ν•λ‚μ΄λ‹¤."
- λ‹¨ν•μ„±μ€ ν•λ“μ›¨μ–΄μ™€ κ°€κΉλ‹¤!
- ν•μ§€λ§ κ°μ²΄μ§€ν–¥ μ–Έμ–΄μ—μ„ μΈν„°νμ΄μ¤λ¥Ό μ‘μ„±ν•κ³  μ΄μ— λ€ν• κµ¬ν„μ²΄λ¥Ό μ‘μ„±ν•λ” κ²ƒμ€ λ§¤μ° μ¤‘μ”ν• μ¶”μƒν™” λ©”μ»¤λ‹μ¦
- λ‹¤ν•μ„±μ— λ€ν• μ„±λ¥ κ±±μ •μ€ μΌλ°μ μΈ μƒν™©μ—μ„ μλ―Έκ°€ μ—†λ‹¤


## μ¨-μ¤νƒ μΉν™

https://die4taoam.tistory.com/52

- RET(Return Address) : ν•¨μ νΈμ¶ μ΄ν›„ λ³µκ·€ μ§€μ μ„ μ¤νƒμ— λ§λ“λ” κ²ƒ
- OSR: RETμ μΌλ°μ μΈ νλ¦„μ—μ„ λ²—μ–΄λ‚ λ£¨ν”„λ¥Ό μ ν”„ν•  μ μλ„λ΅ μµμ ν™”ν•λ” κΈ°λ²•

https://thangavel-blog.medium.com/java-on-stack-replacement-osr-b527ab3fff8c

- OSRμ€ μ¤λ μ‹¤ν–‰λ "ν•«" λ°”μ΄νΈμ½”λ“λ¥Ό μ»΄νμΌν•΄μ¤€λ‹¤

λ‹¨κ³„

1. λ°νƒ€μ„μ΄ νΉμ • λ©”μ†λ“ (ν„μ¬ λ³€μκ°’, ν”„λ΅κ·Έλ¨ μΉ΄μ΄ν„°)
2. λ©”μ†λ“λ¥Ό λ‹¤μ‹ μ»΄νμΌ
3. μ»΄νμΌλ¬λ” μ¤νƒ ν™μ„±ν™” ν”„λ μ„μ„ μƒμ„±ν•κ³  μ΄μ „ λ²„μ „μ—μ„ μ¶”μ¶λ κ°’λ“¤λ΅ μ—…λ°μ΄νΈ
4. μ‹μ¤ν…μ€ μ΄μ „ ν™μ„±ν™” ν”„λ μ„μ„ κµμ²΄ν•κ³  μƒ λ²„μ „μ—μ„ μ¬μ‹¤ν–‰

```bash
<nmethod compile_id='272' compile_kind='osr' compiler='c1' level='3' entry='0x000000010ce0a5c0' size='15200' address='0x000000010ce0a090' relocation_offset='336' insts_offset='1328' stub_offset='11312' scopes_data_offset='11864' scopes_pcs_offset='13552' dependencies_offset='14992' nul_chk_table_offset='15000' metadata_offset='11720' method='java.util.Properties$LineReader readLine ()I' bytes='584' count='49' backedge_count='62873' iicount='49' stamp='0.126'/>
```

- `bytes` : λ©”μ†λ“ ν¬κΈ°
- `compiled_kind='osr'` : OSR κΈ°λ²•μ„ μ‚¬μ©ν–μμ„ λ‚νƒ€λƒ„
- `compiler='c1'` : C1 μ»΄νμΌλ¬λ¥Ό μ‚¬μ©ν–μμ„ λ‚νƒ€λƒ„
- `count` : μ»΄νμΌλ¬μ— μν•΄ λ©”μ†λ“κ°€ νΈμ¶λ νμ
- `backedge_count` : λ£¨ν”„κ°€ ν¬ν•¨λ λ©”μ†λ“λ¥Ό κ°μ§€ν•λ” μ©λ„, μΈν„°ν”„λ¦¬ν„°μ— μν•΄ μ«μκ°€ μ¦κ°€λ¨
- `iicount` : μΈν„°ν”„λ¦¬ν„°κ°€ λ©”μ†λ“λ¥Ό νΈμ¶ν• νμ
