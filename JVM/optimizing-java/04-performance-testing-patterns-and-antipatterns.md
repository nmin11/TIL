## 1. 성능 테스트 유형

- 좋은 성능 테스트는 정량적(quantitative)
  - 어떤 질문을 던져도 실혐 결과를 토대로 수치화한 답변을 내놓을 수 있어야 함
- 성능 테스트로 확인하고 싶은 정량적 질문 리스트와, 테스트가 대상 애플리케이션 입장에서 중요한 이유가 필요

### 1.1 지연 테스트 (latency test)

- 종단 트랜잭션에 걸리는 시간은?
- 가장 일반적인 성능 테스트
- 고객이 트랜잭션을 얼마나 오래 참고 기다려야 하는지
- 목적: 유저 경험의 직접적인 개선 및 SLA 조항 이행
- 단순 평균값만을 지표로 삼으면 안됨

### 1.2 처리율 테스트 (throughput test)

- 현재 시스템이 처리 가능한 동시 트랜잭션 개수는?
- 지연 테스트 다음으로 일반적인 성능 테스트
- 지연 테스트와 함께 수행되곤 함
  - 지연 테스트 수행 시 동시 트랜잭션 개수를 명시하곤 함
  - 지연을 모니터링하면서 테스트
  - 지연 분포의 변곡점이 바로 '최대 처리율'
- 목적: 변곡점의 부하 수준을 포착하는 것

### 1.3 부하 테스트 (load test)

- 특정 부하를 시스템이 감당할 수 있는가?
- '시스템이 이 정도 부하를 견딜 수 있을까?'에 대한 '예/아니오' 답변
- 신규 고객을 유치하거나 이벤트가 있을 때 트래픽을 감당할 수 있는가?

### 1.4 스트레스 테스트 (stress test)

- 이 시스템의 한계점은 어디까지인가?
- 보통 일정 처리율의 트랜잭션을 시스템에 계속 걸어놓고, 시스템 성능이 저하되는 시점을 측정
- 측정값이 나빠지기 직전의 값이 최대 처리율

### 1.5 내구성 테스트 (endurance test)

- 시스템을 장시간 실행할 경우 성능 이상 증상이 나타나는가?
- 메모리 누수, 캐시 오염, 메모리 단편화 등 보통 며칠 단위의 시간이 지나고 나서야 드러나는 문제점 찾기
- 평균 이상의 사용률로 시스템에 일정 부하를 걸어놓고, 갑자기 리소스가 고갈되거나 시스템이 깨지는 지점 찾기
- 빠른 응답을 요구하는 저지연 시스템에서 많이 수행하는 테스트

### 1.6 용량 계획 테스트 (capacity planning test)

- 리소스를 추가한 만큼 시스템이 확장되는가?
- 업그레이드한 시스템이 어느 정도 부하를 감당할 수 있을지 예측
- 예정된 계획의 일부분으로 실행하는 경우가 많음

### 1.7 저하 테스트 (degradation test)

- 시스템이 부분적으로 실패할 경우 어떤 일이 벌어지나?
- 부분 실패 테스트(partial failure test)라고도 함
- 업무 체계가 잘 잡혀있고 정규화된 환경에서는 아주 꼼꼼하게 기획하고 엄격하게 수행하는 테스트
- 이 책에서는 복원 테스트(resilience test) 하나만 생각하면 됨
- 기본적으로 평상시와 같은 부하를 걸어놓고, 시스템의 일부 능력을 제거한 후 어떻게 작동하는지 관찰
- 주요 측정값: 트랜잭션 지연 분포, 처리율
- 넷플릭스의 카오스 몽키(Chaos Monkey)가 대표적인 예

## 2. 기본 베스트 프랙티스

- 성능 튜닝 시 주안점을 두어야 할 3가지 원칙
  1. 나의 관심사가 무엇인지 식별하고 그 측정 방법을 고민한다.
  2. 최적화하기 용이한 부분이 아니라, 중요한 부분을 최적화한다.
  3. 중요한 관심사를 먼저 다룬다.

### 2.1 하향식 성능

- 전체 애플리케이션의 성능 양상부터 먼저 알아보는 접근 방식
- 하향식 성능 접근 방식의 성과를 극대화하려 할 때 전 팀원이 명확하게 이해해야 할 것들
  - 무엇을 측정하는지
  - 무엇을 최적화해야 하는지
  - 성능 테스트 활동을 전체 소프트웨어 개발 주기에서 어떻게 병행할 것인지

### 2.2 테스트 환경 구축

- 성능 테스트 팀이 가장 먼저 할 일
- 테스트 환경은 가급적 모든 면에서 운영 환경과 동일하게 구축해야 함
  - 애플리케이션 서버, 웹 서버, DB, 로드밸런서, 네트워크 방화벽 등
- 인프라 구축 비용이 상당함
  - 그러나 성능 테스트를 안하는 대가가 서비스 중단이라면?
  - 클라우드 기술의 발달로 테스트 환경을 유연하게 구축할 수 있게 되었음

### 2.3 성능 요건 식별

- 성능 평가 지표는 시스템을 전체적으로 바라보며 중요한 측정값을 고려해야 함
- NFR(Non-Functional Requirement): 성능 비기능 요건
- 예시
  - 95% 트랜잭션 지연 100ms 이하
  - 초당 1000개의 트랜잭션 처리
  - 평균 응답 시간 30% 감소
- 이해관계자들이 모여서 측정 대상과 목표를 논의해야 함

### 2.4 자바의 특정 이슈

- JVM 성능은 잘 이해하고 주의 깊게 살펴야 할 복잡 미묘한 부분들이 있음
- 특히 JIT 컴파일을 유심히 살펴봐야 함
  - 최신 JVM은 메소드를 JIT 컴파일해서 최적화한 기계어로 변환할지 분석
  - JIT 컴파일을 안 하기로 결정된 2가지 메소드 유형
    - 자주 실행되는 메소드가 아닐 때
    - 메소드가 너무 크고 복잡할 때
- **JVM 성능 활동을 시작하는 첫 단추**
  - 어떤 메서드가 컴파일 중인지 로그를 남겨 살피기
  - 핵심 코드 경로상의 중요 메소드가 잘 컴파일되고 있는지 확인하기

### 2.5 SDLC 일부로 성능 테스트 수행하기

**Software Development Life Cycle**

- 일류 회사, 수준 높은 팀일수록 성능 테스트를 SDLC의 일부로 수행
- 특히 성능 회귀 테스트(performance regression test)는 상시 수행
- 전용 테스트 환경이 필수적

## 3. 성능 안티패턴 개요

- 안티패턴: 소프트웨어 프로젝트, 팀의 일반적으로 좋지 않은 패턴
- 성능 튜닝은 항상 초기 기획 단계부터 구체적으로 목표를 정해놓고 시작하는 목표 지향형 프로세스로 접근해야 함
- 성능 테스트 관례를 따르며 팀원 간 이성적인 대화를 나누는 팀이 아니라면 안티패턴의 제물이 되기 쉬움
- 캐리 플리첼의 *"개발자가 잘못된 기술을 선택하는 5가지 이유"* 를 살펴볼 것

### 3.1 지루함

- 개발자의 지루함은 프로젝트에 여러 가지 해악을 끼칠 수 있음
- 잘 알려지지 않은 기술을 사용하거나, 필요 이상으로 복잡하게 코딩하거나

### 3.2 이력서 부풀리기

- 연봉을 높이려는 욕심에 프로젝트를 불필요한 방향으로 끌고 가려는 사람이 있을 수 있음
- 그런 개발자가 이직한 후 불필요한 기술이 아주 오랫동안 시스템에 지대한 영향을 마치게 됨

### 3.3 또래 압박

- 가급적 실수를 안 하려는 신입 개발자, 특정 주제를 잘 모른다는 사실을 두려워하는 개발자
- 기술을 결정할 때 관심사를 분명히 밝히고 충분한 논의를 거쳐야 함

### 3.4 이해 부족

- 지금 툴도 이해 못하는데 무턱대고 새로운 툴로 문제를 해결하려는 개발자가 있음
- 새 기술과 현 기술의 균형을 잘 맞춰야 함

### 3.5 오해와 있지도 않은 문제

- 문제를 제대로 이해하지 못한 채 오로지 기술로 문제를 해결하려는 개발자가 있음
- 성능 지표 수집/분석 이후 비로소 문제의 본질을 정확히 이해할 수 있음

<br>

안티패턴 예방을 위해서

- 팀원 모두 기술 이슈를 활발히 공유하는 분위기 적극 장려
- 사실에 근거한 증거를 수집하고 프로토타입을 만들어 조사
