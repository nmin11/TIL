# 컨테이너 인프라 환경 모니터링하기

- 실습 중 사용하던 **m-k8s** 노드에서도 `bpytop` 명령어를 통해 시스템 상태 정보 확인 가능
- 거의 모든 모니터링 도구는 **수집 → 통합 → 시각화** 의 구조로 되어 있음
- 이번 실습 방향
  - 수집 : 모니터링 데이터를 프로메테우스를 통해 수집
  - 통합 : 수집한 정보 모으기
  - 시각화 : 그라파나 이용

<br>
<br>

## 모니터링 도구 선택하기

- 프로메테우스와 그라파나는 오픈 소스 도구
- 오픈 소스는 가능하면 단일 도구 단일 기능 구현을 선호함
  - 물론 서비스형 모니터링 도구는 다름
- 단일 도구가 아닌 혼합 구조를 사용하는 이유
  - 비용
    - 모니터링 대상마다 License 관련 비용 발생
    - 클라우드 같은 과금제 서비스를 사용하면 네트워크와 저장 공간에 따른 추가 비용 발생
  - 보안
    - 서비스형 모니터링 도구들은 대부분 외부에 데이터를 저장해서 모니터링함
    - 내부에서 모든 데이터를 처리하려 하는 경우에는 사용하기 어려움

<br>

### 데이터 수집과 통합 도구

- Prometheus
  - SoundCloud 사에서 자사 서비스의 모니터링을 위해 개발한 도구이며 현재 오픈 소스
  - 시계열 데이터 베이스\* 내장
  - 자체적인 질의 페이지 외 시각화 기능은 없지만 그라파나와 연계하면 가능
  - 중앙 서버에서 에이전트의 데이터를 수집하는 **Pull 방식**
    - 쿠버네티스 환경에서 설치된 에이전트를 통해 노드와 컨테이너 상태를 모두 수집 및 모니터링 가능
  - 에이전트를 통해 내부 메트릭\*을 외부로 노출
    - 사용자가 수집 대상에 접속할 수 있으면 개인 컴퓨터에서도 메트릭을 가져올 수 있음
  - 일회성으로 모니터링 대상에 대한 세부 메트릭도 간단하게 웹 브라우저로 확인 가능
  - 오픈 소스 모델이고 자료가 많으며 연계 지원도 활발하므로 직접 모니터링 시스템을 구축할 때 좋음
- Datadog
  - 모니터링 데이터를 업체에서 관리하는 **SaaS 형태**
  - 웹 사이트에서 모니터링 대상 관리 가능
  - 쿠버네티스를 비롯해서 여러 클라우드 서비스나 애플리케이션과 연결이 용이하므로 관리 부담이 적음
  - 모니터링 대상마다 요금을 부과하므로 대상이 늘면 비용이 커짐
- New Relic
  - **SaaS 형태**
  - 데이터독과 비교했을 때 APM(Application Performance Monitoring)에 더 특화되어 있음
  - 마찬가지로 모니터링 대상이 많아지면 비용이 커짐
- InfluxDB
  - **시계열 데이터베이스**
  - 오픈 소스 무료 버전, 클라우드 SaaS 버전, 라이선스 구매 후 설치하는 엔터프라이즈 버전이 있음
  - 무료 버전은 프로메테우스와 유사하지만 인플럭스DB가 성능이 뛰어나 대량의 이벤트를 모니터링하기에 적합
  - 엔터프라이즈 버전은 프로메테우스의 부족한 고가용성을 위한 분산 저장을 좀 더 쉽게 구성할 수 있도록 해줌
  - 프로메테우스와 더불어 오픈 소스로 모니터링 플랫폼을 구축하기 위한 최선의 도구
  - 하지만 간단한 구성으로 데이터를 받아오는 프로메테우스에 비해 상대적으로 구성이 어려움

※ 시계열 데이터베이스

- 시간을 축(키)으로 시간의 흐름에 따라 발생하는 데이터를 저장하는 데 최적화된 데이터베이스
- 예시 : 패킷, IoT 센서 값, 이벤트 로그 등

※ Metric

- 현재 시스템의 상태를 알 수 있는 **측정값**
- 컨테이너 인프라 환경에서는 크게 2가지 상태로 메트릭 구분
  - **System Metric** : 파드 같은 오브젝트에서 측정되는 CPU와 메모리 사용량을 나타냄
  - **Service Metric** : HTTP 상태 코드 같은 서비스 상태를 나타내는 지표

|    구분     | Prometheus | Datadog  | New Relic |    InfluxDB     |
| :---------: | :--------: | :------: | :-------: | :-------------: |
|    가격     |    무료    |   유료   |   유료    |     유/무료     |
|    형태     |   설치형   | 서비스형 | 서비스형  | 서비스형/설치형 |
|  참고 자료  | 매우 많음  |   많음   |   많음    |      많음       |
| 기능 확장성 | 매우 좋음  |   좋음   |   좋음    |      좋음       |

<br>

### 데이터 시각화 도구

- 프로메테우스와 인플럭스DB는 서비스형 수집/통합 도구에 비해 시각화 부분이 약하므로<br>다음과 같은 도구들을 함께 사용해주면 좋음
- Grafana
  - Grafana Labs에서 개발한 특정 소프트웨어에 종속되지 않은 독립적 시각화 도구
  - 30가지 이상의 다양한 수집 도구 및 데이터베이스들과의 연계를 지원함
  - 주로 시계열 데이터의 시각화에 많이 쓰이지만,<br>관계형 데이터베이스의 데이터를 표 형태로 시각화할 수도 있음
  - 플러그인과 개별 유저들의 대시보드의 공유가 매우 활발함
  - 오픈 소스라서 사용자의 요구 사항에 맞게 수정이 가능하고 설치형과 서비스형 모두 선택 가능
- Kibana
  - ElasticSearch를 개발한 Elastic에서 만든 시각화 도구
  - 엘라스틱서치에 적재된 데이터 시각화, 검색, 분석
  - 엘라스틱서치의 데이터만 시각화가 가능하므로 프로메테우스 사용 시<br>시계열 데이터를 Metricbeat라는 도구로 전달해야 하는 불편함이 있음
  - 하지만 시각화 기능이 매우 강력하므로 시각화를 중점적으로 다룬다면 추천
- Chronograf
  - InfluxDB를 만든 InfluxData에서 만든 시각화 도구
  - 오픈 소스이므로 사용자 편의에 맞게 수정 가능
  - 설치형과 서비스형을 용도에 따라 선택 가능
  - 키바나와 마찬가지로 자사 제품인 인플럭스DB만 시각화 가능

|    구분     |         Grafana         |     Kibana      |   Chronograf    |
| :---------: | :---------------------: | :-------------: | :-------------: |
|    가격     |         유/무료         |     유/무료     |     유/무료     |
|    형태     |     서비스형/설치형     | 서비스형/설치형 | 서비스형/설치형 |
| 시각화 대상 | 다양한 대상 시각화 가능 |  엘라스틱서치   |   인플럭스DB    |
|   정보량    |          많음           |      많음       |      적음       |
| 기능 확장성 |          좋음           |      좋음       |      적음       |

- 엘라스틱 제품들을 설치형으로 구성하면 무료 사용 가능
- 하지만 엘라스틱서치로 저장해야 하므로 필요한 도구가 늘어남

<br>
<br>

## 쿠버네티스 환경에 적합한 모니터링 데이터 수집 방법

- 쿠버네티스 노드는 **kubelet**을 통해 파드 관리
- 파드의 CPU나 메모리 같은 메트릭 정보 수집을 위해 **cAdvisor** 사용
  - cAdvisor는 구글이 만든 컨테이너 메트릭 수집 도구
  - 쿠버네티스 클러스터 위에 배포된 여러 컨테이너가 사용하는 메트릭 정보를 수집한 후<br>이를 가공해서 kubelet에 전달하는 역할 수행
- 하지만 cAdvisor로 수집되고 kubelet으로 공개되는 데이터가 있어도<br>외부에서 이를 모아서 표현해 주는 도구가 없다면 의미가 없음
- 그러므로 메트릭 데이터를 수집하는 목적으로 메트릭 서버를 설치해 HPA와 같은 기능 구현 후<br>쿠버네티스 대시보드를 설치해서 현재 상태 확인
- 이렇게 메트릭 서버에서 수집한 데이터로 여러 기능을<br>수행하도록 구성한 것을 **Resource Metric Pipeline**이라고 함
- 하지만 메트릭 서버는 집계한 데이터를 메모리에만 저장하므로<br>데이터 영구 보존이 어렵고 현 시점의 데이터만 출력됨
- 그러므로 메트릭 데이터를 저장 공간에 따로 저장하는 **Full Monitoring Pipeline** 구축하기를 권장
- 이 설계 방식을 반영한 도구가 **프로메테우스**
- 완전한 모니터링 파이프라인으로 구성한 프로메테우스는 여러 수집 대상이 공개하는<br>메트릭 데이터를 모아 시계열 데이터베이스에 저장함
- 누적된 메트릭 데이터로 쿠버네티스 인프라 상태 변화를 파악 가능하며<br>적절한 위험 감지 및 조치 가능
