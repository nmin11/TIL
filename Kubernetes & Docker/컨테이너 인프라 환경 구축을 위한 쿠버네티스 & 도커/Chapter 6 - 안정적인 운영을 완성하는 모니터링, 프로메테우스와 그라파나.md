# 컨테이너 인프라 환경 모니터링하기

- 실습 중 사용하던 **m-k8s** 노드에서도 `bpytop` 명령어를 통해 시스템 상태 정보 확인 가능
- 거의 모든 모니터링 도구는 **수집 → 통합 → 시각화** 의 구조로 되어 있음
- 이번 실습 방향
  - 수집 : 모니터링 데이터를 프로메테우스를 통해 수집
  - 통합 : 수집한 정보 모으기
  - 시각화 : 그라파나 이용

<br>
<br>

## 모니터링 도구 선택하기

- 프로메테우스와 그라파나는 오픈 소스 도구
- 오픈 소스는 가능하면 단일 도구 단일 기능 구현을 선호함
  - 물론 서비스형 모니터링 도구는 다름
- 단일 도구가 아닌 혼합 구조를 사용하는 이유
  - 비용
    - 모니터링 대상마다 License 관련 비용 발생
    - 클라우드 같은 과금제 서비스를 사용하면 네트워크와 저장 공간에 따른 추가 비용 발생
  - 보안
    - 서비스형 모니터링 도구들은 대부분 외부에 데이터를 저장해서 모니터링함
    - 내부에서 모든 데이터를 처리하려 하는 경우에는 사용하기 어려움

<br>

### 데이터 수집과 통합 도구

- Prometheus
  - SoundCloud 사에서 자사 서비스의 모니터링을 위해 개발한 도구이며 현재 오픈 소스
  - 시계열 데이터 베이스\* 내장
  - 자체적인 질의 페이지 외 시각화 기능은 없지만 그라파나와 연계하면 가능
  - 중앙 서버에서 에이전트의 데이터를 수집하는 **Pull 방식**
    - 쿠버네티스 환경에서 설치된 에이전트를 통해 노드와 컨테이너 상태를 모두 수집 및 모니터링 가능
  - 에이전트를 통해 내부 메트릭\*을 외부로 노출
    - 사용자가 수집 대상에 접속할 수 있으면 개인 컴퓨터에서도 메트릭을 가져올 수 있음
  - 일회성으로 모니터링 대상에 대한 세부 메트릭도 간단하게 웹 브라우저로 확인 가능
  - 오픈 소스 모델이고 자료가 많으며 연계 지원도 활발하므로 직접 모니터링 시스템을 구축할 때 좋음
- Datadog
  - 모니터링 데이터를 업체에서 관리하는 **SaaS 형태**
  - 웹 사이트에서 모니터링 대상 관리 가능
  - 쿠버네티스를 비롯해서 여러 클라우드 서비스나 애플리케이션과 연결이 용이하므로 관리 부담이 적음
  - 모니터링 대상마다 요금을 부과하므로 대상이 늘면 비용이 커짐
- New Relic
  - **SaaS 형태**
  - 데이터독과 비교했을 때 APM(Application Performance Monitoring)에 더 특화되어 있음
  - 마찬가지로 모니터링 대상이 많아지면 비용이 커짐
- InfluxDB
  - **시계열 데이터베이스**
  - 오픈 소스 무료 버전, 클라우드 SaaS 버전, 라이선스 구매 후 설치하는 엔터프라이즈 버전이 있음
  - 무료 버전은 프로메테우스와 유사하지만 인플럭스DB가 성능이 뛰어나 대량의 이벤트를 모니터링하기에 적합
  - 엔터프라이즈 버전은 프로메테우스의 부족한 고가용성을 위한 분산 저장을 좀 더 쉽게 구성할 수 있도록 해줌
  - 프로메테우스와 더불어 오픈 소스로 모니터링 플랫폼을 구축하기 위한 최선의 도구
  - 하지만 간단한 구성으로 데이터를 받아오는 프로메테우스에 비해 상대적으로 구성이 어려움

※ 시계열 데이터베이스

- 시간을 축(키)으로 시간의 흐름에 따라 발생하는 데이터를 저장하는 데 최적화된 데이터베이스
- 예시 : 패킷, IoT 센서 값, 이벤트 로그 등

※ Metric

- 현재 시스템의 상태를 알 수 있는 **측정값**
- 컨테이너 인프라 환경에서는 크게 2가지 상태로 메트릭 구분
  - **System Metric** : 파드 같은 오브젝트에서 측정되는 CPU와 메모리 사용량을 나타냄
  - **Service Metric** : HTTP 상태 코드 같은 서비스 상태를 나타내는 지표

|    구분     | Prometheus | Datadog  | New Relic |    InfluxDB     |
| :---------: | :--------: | :------: | :-------: | :-------------: |
|    가격     |    무료    |   유료   |   유료    |     유/무료     |
|    형태     |   설치형   | 서비스형 | 서비스형  | 서비스형/설치형 |
|  참고 자료  | 매우 많음  |   많음   |   많음    |      많음       |
| 기능 확장성 | 매우 좋음  |   좋음   |   좋음    |      좋음       |

<br>

### 데이터 시각화 도구

- 프로메테우스와 인플럭스DB는 서비스형 수집/통합 도구에 비해 시각화 부분이 약하므로<br>다음과 같은 도구들을 함께 사용해주면 좋음
- Grafana
  - Grafana Labs에서 개발한 특정 소프트웨어에 종속되지 않은 독립적 시각화 도구
  - 30가지 이상의 다양한 수집 도구 및 데이터베이스들과의 연계를 지원함
  - 주로 시계열 데이터의 시각화에 많이 쓰이지만,<br>관계형 데이터베이스의 데이터를 표 형태로 시각화할 수도 있음
  - 플러그인과 개별 유저들의 대시보드의 공유가 매우 활발함
  - 오픈 소스라서 사용자의 요구 사항에 맞게 수정이 가능하고 설치형과 서비스형 모두 선택 가능
- Kibana
  - ElasticSearch를 개발한 Elastic에서 만든 시각화 도구
  - 엘라스틱서치에 적재된 데이터 시각화, 검색, 분석
  - 엘라스틱서치의 데이터만 시각화가 가능하므로 프로메테우스 사용 시<br>시계열 데이터를 Metricbeat라는 도구로 전달해야 하는 불편함이 있음
  - 하지만 시각화 기능이 매우 강력하므로 시각화를 중점적으로 다룬다면 추천
- Chronograf
  - InfluxDB를 만든 InfluxData에서 만든 시각화 도구
  - 오픈 소스이므로 사용자 편의에 맞게 수정 가능
  - 설치형과 서비스형을 용도에 따라 선택 가능
  - 키바나와 마찬가지로 자사 제품인 인플럭스DB만 시각화 가능

|    구분     |         Grafana         |     Kibana      |   Chronograf    |
| :---------: | :---------------------: | :-------------: | :-------------: |
|    가격     |         유/무료         |     유/무료     |     유/무료     |
|    형태     |     서비스형/설치형     | 서비스형/설치형 | 서비스형/설치형 |
| 시각화 대상 | 다양한 대상 시각화 가능 |  엘라스틱서치   |   인플럭스DB    |
|   정보량    |          많음           |      많음       |      적음       |
| 기능 확장성 |          좋음           |      좋음       |      적음       |

- 엘라스틱 제품들을 설치형으로 구성하면 무료 사용 가능
- 하지만 엘라스틱서치로 저장해야 하므로 필요한 도구가 늘어남

<br>
<br>

## 쿠버네티스 환경에 적합한 모니터링 데이터 수집 방법

- 쿠버네티스 노드는 **kubelet**을 통해 파드 관리
- 파드의 CPU나 메모리 같은 메트릭 정보 수집을 위해 **cAdvisor** 사용
  - cAdvisor는 구글이 만든 컨테이너 메트릭 수집 도구
  - 쿠버네티스 클러스터 위에 배포된 여러 컨테이너가 사용하는 메트릭 정보를 수집한 후<br>이를 가공해서 kubelet에 전달하는 역할 수행
- 하지만 cAdvisor로 수집되고 kubelet으로 공개되는 데이터가 있어도<br>외부에서 이를 모아서 표현해 주는 도구가 없다면 의미가 없음
- 그러므로 메트릭 데이터를 수집하는 목적으로 메트릭 서버를 설치해 HPA와 같은 기능 구현 후<br>쿠버네티스 대시보드를 설치해서 현재 상태 확인
- 이렇게 메트릭 서버에서 수집한 데이터로 여러 기능을<br>수행하도록 구성한 것을 **Resource Metric Pipeline**이라고 함
- 하지만 메트릭 서버는 집계한 데이터를 메모리에만 저장하므로<br>데이터 영구 보존이 어렵고 현 시점의 데이터만 출력됨
- 그러므로 메트릭 데이터를 저장 공간에 따로 저장하는 **Full Monitoring Pipeline** 구축하기를 권장
- 이 설계 방식을 반영한 도구가 **프로메테우스**
- 완전한 모니터링 파이프라인으로 구성한 프로메테우스는 여러 수집 대상이 공개하는<br>메트릭 데이터를 모아 시계열 데이터베이스에 저장함
- 누적된 메트릭 데이터로 쿠버네티스 인프라 상태 변화를 파악 가능하며<br>적절한 위험 감지 및 조치 가능

<br>
<br>

# 프로메테우스로 모니터링 데이터 수집과 통합하기

- 프로메테우스는 많은 종류의 오브젝트를 설치함
- 오브젝트를 통해 모니터링에 필요한 데이터를 수집하고 저장

<br>

### prometheus-server

- 프로메테우스의 주요 기능 수행
- 3가지 역할을 맡음
  - 여러 대상에서 공개된 메트릭을 수집하는 수집기
    - **Service Discovery** 방법으로 수집함 (다음 부분에서 배우게 될 것)
  - 수집한 시계열 메트릭 데이터를 저장하는 시계열 데이터베이스
  - 저장된 데이터를 질의하거나 수집 대상의 상태를 확인할 수 있는 웹 UI
    - 프로메테우스를 다루려면 웹 UI를 가장 먼저 알아야 함 (다음 부분에서 배우게 될 것)

<br>

### node-exporter

- 노드의 시스템 메트릭 정보를 HTTP로 공개하는 역할
- 설치된 노드에서 특정 파일들을 읽고, 이를 프로메테우스 서버가 수집할 수 있는<br>메트릭 데이터로 변환한 후 노드 익스포터에서 HTTP 서버로 공개
- 공개된 내용을 프로메테우스 서버에서 수집하는 구조

<br>

### kube-state-metrics

- API 서버로 쿠버네티스 클러스터의 여러 메트릭 데이터 수집 후<br>이를 프로메테우스 서버가 수집할 수 있는 메트릭 데이터로 변환해 공개하는 역할
- 프로메테우스가 쿠버네티스 클러스터의 여러 정보를 손쉽게 획득할 수 있도록 해줌

<br>

### alertmanager

- 프로메테우스에 경보 규칙을 설정하고,<br>경보 이벤트가 발생하면 설정된 경보 메시지를 대상에게 전달하는 기능 제공
- 프로메테우스 서버에 주기적으로 경보를 보낼 대상을 감시해서 안정적인 운영을 도움

<br>

### pushgateway

- 배치와 스케줄 작업 시 수행되는 일회성 작업들의 상태를 저장하고 모아서<br>프로메테우스가 주기적으로 가져갈 수 있도록 공개함
- 일반적으로 짧은 시간 동안 실행되고 종료되는 배치성 프로그램의 메트릭 저장이나<br>외부망에서 접근할 수 없는 내부 시스템의 메트릭을 프록시 형태로 제공하는 용도

<br>
<br>

## 헬름으로 프로메테우스 설치하기

- 프로메테우스는 젠킨스처럼 헬름으로 손쉽게 설치 가능

※ prometheus-install.sh

```sh
#!/usr/bin/env bash
helm install prometheus edu/prometheus \
--set pushgateway.enabled=false \
--set alertmanager.enabled=false \
--set nodeExporter.tolerations[0].key=node-role.kubernetes.io/master \
--set nodeExporter.tolerations[0].effect=NoSchedule \
--set nodeExporter.tolerations[0].operator=Exists \
--set server.persistentVolume.existingClaim="prometheus-server" \
--set server.securityContext.runAsGroup=1000 \
--set server.securityContext.runAsUser=1000 \
--set server.service.type="LoadBalancer" \
--set server.extraFlags[0]="storage.tsdb.no-lockfile"
```

- helm install
  - edu 차트 저장소의 prometheus 차트를 사용해서 prometheus 릴리스 설치
- pushgateway.enabled=false
  - pushgateway를 사용하지 않도록 설정
  - pushgateway는 짧은 작업의 메트릭을 적재하거나 보안상 내부 접근을 제어하는<br>폐쇄망 등에서 프로메테우스로 데이터를 내보내는 데 사용
- nodeExporter.tolerations[0]
  - taints가 설정된 노드의 설정을 무시하는 tolerations를 설정
  - tolerations 설정 시 마스터 노드에도 노드 익스포터 배포가 가능하며<br>프로메테우스가 마스터 노드의 메트릭 데이터 수집 가능
- server.persistentVolume.existingClaim
  - PVC 동적 프로비저닝을 사용할 수 없는 가상 머신 환경이기에 미리 만들어둔 PVC 사용 설정
- server.securityContext
  - 프로메테우스 서버 구성 시 컨테이너에 할당할 사용자 ID와 그룹 ID 설정
- server.service.type
  - MetalLB로부터 외부 IP를 할당받기 위해서 타입을 `LoadBalancer` 설정
- server.extraFlags[0]
  - 프로메테우스 설정 변경 시 lockfile이 있으면 변경 작업이 실패할 수 있으므로<br>lockfile이 생성되지 않도록 설정

<br>
<br>

## 프로메테우스의 웹 UI 다루기

### Graph

- 프로메테우스 접속 시 가장 먼저 만나게 되는 메뉴
- 프로메테우스의 웹 UI에서 제공하는 가장 중요한 내용을 처리하는 페이지
- Enable query history
  - 프로메테우스가 적재한 메트릭 데이터를 조회할 수 있는 표현식을 입력하는 곳
  - 사용하는 표현식은 **PromQL(Prometheus Query Language)**이라는 프로메테우스의 쿼리 언어
    - 시계열 데이터베이스를 RDBMS처럼 쿼리문을 작성하여 효과적으로 필요한 메트릭 추출
- Graph
  - PromQL을 통해 메트릭 데이터를 확인할 때 시각적으로 표현해주는 옵션
  - 데이터를 시각화한 영역형 또는 막대형 차트를 보여줌
- Console
  - PromQL로 추출된 데이터를 보여주는 기본 옵션
  - 표 형식으로 표현하기 때문에 개별 데이터 파악에 용이
- Add Graph
  - 그래프 추가가 아닌, 쿼리 입력기를 하나 더 추가해서 다른 메트릭을 확인하는 버튼
- Remove Graph
  - 현재 쿼리 입력기 제거

<br>

### Alert

- 현재 프로메테우스 서버에 등록된 경보 규칙과 경보 발생 여부 확인 가능

<br>

### Status

- Runtime & Build Information
  - 런타임 관련 정보, 버전을 나타내는 빌드 정보 등 여러 정보 확인 가능
- Command-Line Flags
  - 프로메테우스 서버가 실행될 때 인자로 입력 받았던 값을 보여줌
- Configuration
  - 프로메테우스 서버가 구동될 때 설정된 값 표시
- Rules
  - 프로메테우스 서버에 등록된 다양한 규칙 확인
- Targets
  - 프로메테우스 서버가 수집해오는 대상의 상태 확인
- Service Discovery
  - 프로메테우스 서버가 서비스 디스커버리 방식으로 수집한 대상들에 대한 정보 요약

<br>

**Status > Targets**

- 프로메테우스가 메트릭 데이터를 수집하는 대상과 메트릭 데이터를 공개하는 대상의 상태 표시
- 실습 상에선 프로메테우스 서버가<br>쿠버네티스 API 서버, 노드, cAdvisor, 파드, 자기 자신이 공개하는 메트릭 데이터를 `/metrics`로 수집
- cAdvisor의 메트릭만 `/metrics/cAdvisor`
  - 메트릭 공개 대상에 따라 공개 경로를 다르게 설정할 수 있기 때문
- 실습 상의 데이터는 저자가 미리 입력해 둔 것이 아닌,<br>프로메테우스가 수집 대상을 확인하는 특별한 방법 덕분

<br>
<br>

## 서비스 디스커버리로 수집 대상 가져오기

- 프로메테우스가 수집 대상을 자동으로 인식하고 수집할 수 있는 것은 **서비스 디스커버리** 덕분
- 작동 순서
  1. 프로메테우스 서버가 ConfigMap에 기록된 내용을 바탕으로 대상을 읽어옴
  2. 읽어온 대상에 대한 메트릭을 가져오기 위해 API 서버에 정보 요청
  3. 요청을 통해 알아온 경로로 메트릭 데이터 수집
- 위 순서대로 프로메테우스 서버와 API 서버가 주기적으로 데이터를 주고받아<br>수집 대상을 업데이트하고, 수집 대상에서 공개되는 메트릭을 자동 수집
- 2가지 경로
  - **cAdvisor** : 쿠버네티스 API 서버에 직접 연결된 경로를 통해 메트릭 수집
  - **Agent** : API 서버가 알려준 경로를 통해 메트릭 수집

※ 프로메테우스에서의 에이전트는 보통 익스포터라고 하므로 이후 익스포터라고 부를 것

<br>

### cAdvisor

- cAdvisor의 메트릭이 API 서버를 통해 노출되면<br>프로메테우스 서버가 쉽게 수집하도록 변환하는 과정을 거침
- 각 노드에 컨테이너 시스템 정보를 담고 있는 특정 파일들을 읽어 들여 메트릭 수집
- 컨테이너 메트릭을 프로메테우스의 메트릭으로 변환해서 공개해줌

<br>

### 익스포터

- 서비스 디스커버리의 수집은 자동이지만 익스포터는 2가지 사전 준비를 해야 함
  - API 서버에 등록되어 경로를 알 수 있도록 해야 함
  - 익스포터가 데이터를 프로메테우스 타입으로 노출해야 함

※ annotation으로 메트릭 수집하기

1. annotation이 매니페스트에 추가되어 있어야 함<br>annotation에 추가되는 구문은 prometheus.io/로 시작
2. 매니페스트를 쿠버네티스 클러스터에 배포하여 annotation을 포함한 정보를 API 서버에 등록
3. 프로메테우스 서버가 prometheus.io/로 시작하는 annotation 정보를 기준으로 대상 주소를 만듦
4. 프로메테우스 서버가 annotation을 기준으로 만든 대상 주소로 요청을 보내 메트릭 데이터 수집

※ 프로메테우스가 메트릭을 공개하는 2가지 방법

1. 프로그래밍 언어의 프로메테우스 SDK를 사용해서 직접 메트릭 공개
2. 이미 만들어 둔 익스포터를 사용해서 메트릭 공개

※ 멀티 컨테이너 패턴

- 파드 내부에 컨테이너 여러 개를 구성하는 방법들
- Sidecar
  - 메인 컨테이너의 기능을 확장하거나 기능을 향상하고자 할 때 추가하는 패턴
- Ambassador
  - 사용자가 외부에서 접근할 때 앰배서더 컨테이너를 통해 통신이 이루어지는 형태
  - 세부적인 외부 접근 대상이나 방법은 앰배서더 컨테이너에 위임
  - 주로 프록시 컨테이너를 구성해서 외부의 접근을 제어하고 내부 자원을 보호하는 구성
- Adapter
  - 메인 컨테이너 정보를 외부에서 사용할 수 있는 형식으로 변환하는 컨테이너가 추가된 형태

<br>
<br>

## 노드 익스포터로 쿠버네티스 노드 메트릭 수집하기

- 노드 익스포터는 익스포터 중에서도 쿠버네티스 노드 상태 값을 메트릭으로 추출하는 데 특화되어 있음
- 노드의 `/proc` 와 `/sys` 에 있는 값을 메트릭으로 노출하도록 구현되어 있음
- 노드 익스포터를 실행하기 위해 쿠버네티스 노드마다 1개씩 배포할 수 있는 데몬셋으로 구현되어 배포됨
- `/proc`
  - 리눅스 운영 체제에서 구동 중인 프로세스들의 정보를 파일 시스템 형태로 연결한 디렉토리
  - 디렉토리 안에 현재 구동 중인 프로세스들의 ID가 디렉토리 형태로 나타남
  - 각 디렉토리 내부에 해당 프로세스에 대한 상태나 실행 환경에 대한 정보가 들어 있음
  - 모니터링 도구는 이를 통해 구동 중인 프로세스의 정보, 상태, 자원 사용량 등을 알 수 있음
- `/sys`
  - 저장 장치, 네트워크 장치, 입출력 장치 등을 운영 체제에서 사용할 수 있도록<br>파일 시스템 형태로 연결한 디렉토리
  - 내부에 있는 파일들을 분석하면 전체 장치의 상태를 알 수 있음
- 노드 익스포터는 각 쿠버네티스 노드의 `/proc`, `/sys`에 있는 파일들을 읽어서<br>프로메테우스가 받아들일 수 있는 메트릭 형태로 변환<br>그리고 변환한 메트릭을 HTTP 서버를 통해 `/metrics` 주소로 공개함

※ cAdvisor의 메트릭은 **container**로 시작하고 노드 익스포터의 메트릭은 **node**로 시작함<br>쿠버 스테이트 메트릭은 **kube**로 시작함

<br>
<br>

## 쿠버 스테이트 메트릭으로 쿠버네티스 클러스터 메트릭 수집하기

- 쿠버 스테이트 메트릭은 쿠버네티스 상태를 보여주는 메트릭
- 쿠버네티스 상태에 관한 정보를 가져와서 프로메테우스가 받아들일 수 있는 메트릭 형태로 변환<br>변환한 메트릭을 HTTP 서버를 통해 `metrics` 주소로 공개
- 각 노드의 특정 디렉토리를 마운트해서 사용하지 않고 이미 API 서버에 모인 값들을 수집

<br>
<br>

# PromQL로 메트릭 데이터 추출하기

- 현업에선 수집된 메트릭 데이터 자체보다는 그것을 가공한 뒤 추출하는 경우가 많음
- 그렇기 때문에 PromQL의 표현식과 데이터 추출 방법을 알아야 함

<br>
<br>

## 메트릭 데이터의 구조

- 간단한 예제 : `up{job="prometheus"}`
  - `up`은 수집 대상이 작동하고 있는지 알려줌
  - `up`이라는 메트릭 이름을 가지는 대상을 검색하는데, `job="prometheus"`라는 조건을 건 것
  - `{}` 안의 내용을 일반적으로 필터링이라고 함

<br>

### 메트릭 값의 종류

- Counter
  - 누적된 값을 표현하는 데 사용하는 메트릭 타입
  - 카운터에 누적된 값으로 구간별 변화율을 파악해서 해당 값이 어느 정도 추세로 증가하는지 알 수 있음
  - 이벤트나 오류 등이 급증하는 구간을 파악하는 데 적합
  - 값보다는 값의 변화율을 주로 확인
- Gauge
  - 특정 시점의 값을 표현하는 데 사용하는 메트릭 타입
  - 카운터는 증가만을 고려하지만 게이지는 시점별로 증가나 감소를 모두 표현 가능
  - CPU 온도나 메모리 사용량 등 조회하는 순간의 값이 중요할 때 사용
- Histogram
  - 사전에 미리 정의된 구간 안에 있는 메트릭 값의 빈도 측정
  - 익스포터를 구현하는 단계에서 정의한 구간을 **bucket**이라고 함
  - 예를 들어 히스토그램을 사용해서 클라이언트가 서버로 HTTP 요청을 한 경우<br>응답 시간에 맞는 버킷에 값을 추가하고 이벤트 횟수를 저장해서 표시할 수 있음
- Summary
  - 구간 내에 있는 메트릭 값의 빈도 측정
  - 예를 들어 클라이언트 요청에 따른 응답 시간을 관측하고 저장할 때 사용
  - 히스토그램과 달리 프로메테우스 자체 단위로 구간을 미리 정해둠

<br>

### 메트릭 레이블

- 모든 메트릭 데이터는 하나 이상의 레이블을 가짐
- 프로메테우스의 레이블은 메트릭 데이터의 다양한 내용을 표현하는 유일한 방법
- 제공하고 싶은 다수의 내용을 key-value 형태로 넣음

<br>

### 메트릭 레이블 매처

- 메트릭 레이블에 조건을 줘서 검색하는 방법을 **Label Matchers**라고 함
- 레이블이 존재할 경우 그에 해당하는 메트릭 데이터를 추출함
- 총 4가지 조건 기호가 있음
  - `=` : 조건에 넣은 값과 레이블 값이 같은 메트릭 출력
  - `!=` : 조건에 넣은 값과 레이블 값이 다른 메트릭 출력
  - `=~` : 조건에 넣은 정규 표현식에 해당하는 메트릭 출력
  - `!~` : 조건에 넣은 정규 표현식에 해당하지 않는 메트릭 출력

<br>
<br>

## PromQL 연산자

- 메트릭의 값을 이용한 여러 가지 활용 방법을 제공하며 크게 4가지로 구분됨
- 비교 연산자
  - 레이블 매처와 유사한 형태이지만 비교 대상이 숫자
  - `==` `!=` `>` `<` `>=` `<=`
- 논리 연산자
  - 수집된 메트릭에서 보고 싶은 범위 지정
  - and, or, unless
- 산술 연산자
  - 사칙 연산 : `+` `-` `*` `/`
  - 나머지 : `%`
  - 지수 : `^`
- 집계 연산자
  - avg, sum, count와 같이 수집된 메트릭 값을 좀 더 의미 있는 데이터로 정리

<br>
<br>

## PromQL 데이터 타입

- 프로메테우스 데이터베이스는 시계열 데이터베이스인데 왜 메트릭 데이터는 시간 정보가 안 보일까?
- 메트릭 데이터가 현재 시간을 내포하기 때문
- 시간을 포함한 메트릭 데이터를 확인하려면 `[구간 값]`을 입력해야 함
  - 예시 : `node_cpu_seconds_total[5m]`
  - @ 뒤에 표시되는 숫자는 **유닉스 시간**
- 메트릭 데이터를 받아오는 구간을 프로메테우스에서는 **Range Selector**라고 함
- 레인지 셀렉터 설정 시 메트릭 값과 함께 시간 정보가 나타남
- 레인지 셀렉터 단위 : ms, s, m, h, d, w, y
- **Range vector** : 구간이 있는 PromQL 데이터 타입
- **Instant vector** : 특정 시점에 대한 메트릭 값만 가지는 PromQL 데이터 타입
- **Scalar type** : 실수 값 표현, 주로 인스턴트 벡터 값을 변경하는 용도
- **String type** : 문자열 표현, 프로메테우스 2.0부터는 사용하지 않음

<br>

### 시계열 메트릭 데이터로 그래프 그리기

- 카운터 타입은 항상 증가하기에 의미 있는 메트릭 데이터의 흐름을 보려면 게이지 타입의 메트릭을 사용해야 함
- 메트릭 값에 따라 카운터 타입만 제공하는 경우도 있음
  - 예시 : `node_cpu_seconds_total`
- 위와 같은 경우 레인지 벡터로 구성된 값들의 변화를 계산해서 변화율을 그래프로 그려야 함
- 근데 레인지 벡터의 변화율을 계산하려면 또 다른 연산 방법이 필요함

<br>
<br>

## PromQL 함수

|   종류    |               용도               | 함수                                                                             |
| :-------: | :------------------------------: | :------------------------------------------------------------------------------- |
| 연산 함수 |            수학 연산             | abs(절댓값), ceil(올림), floor(내림)<br>round(반올림), predict_linear(예측값) 등 |
| 변환 함수 |       데이터 타입 간 변환        | scalar, vector, rate(변화율), irate(순간 변화율) 등                              |
| 집계 함수 | 수집된 레인지 벡터의 데이터 집계 | avg_over_time(평균), sum_over_time(합계)<br>count_over_time(계수) 등             |

<br>

### 변화율을 나타내는 rate

- 수집한 값들의 변화율을 구할 때 사용
- 주로 값이 증가하는 카운터 형식의 메트릭에 사용
- 지정된 구간이 얼마나 빠르게 변화했는지 알기 위한 지표
- 프로메테우스가 제공하는 그래프의 단점
  - 변화율 값을 정확하게 표시하지 못함
  - 제한이 많은 꺾은선 그래프로 표시됨
  - 하나의 패널이라서 여러 가지의 PromQL 쿼리 비교 불가

<br>

### 순간변화율을 나타내는 irate

- rate는 구간 시작 값과 구간 종료 값의 차이에 대한 변화율
- irate는 구간 종료 바로 전 값과 구간 종료 값의 차이에 대한 변화율
- 따라서 구간이 매우 길면 irate의 변화율은 큰 의미가 없으므로 rate 사용

<br>

### 추세를 보여주는 predict_linear

- 레인지 벡터로 수집된 과거 메트릭 데이터를 기반으로 앞으로 생성될 메트릭 값 예측
- 사용 방법 : `predict_linear(쿼리,시간(초))`

<br>
<br>

## 서머리와 히스토그램

- 두 메트릭 값은 구간 내 특정 메트릭 값이 나타나는 빈도를 알려줌
- 서머리는 익스포터에서 이미 만들어진 값을 보여주고, 히스토그램은 요청받을 때 계산해서 보여줌

<br>

### 서머리

- 이미 공개된 메트릭 값을 조회하면 바로 확인 가능
- 예시 : `prometheus_target_interval_length_seconds`
- 결과에서 **quantile**(분위수) 값에 매핑되는 매트릭 값 확인

<br>

### 히스토그램

- 쿼리 입력기에 쿼리를 보내면 그때서야 내부 계산식을 통해 히스토그램 메트릭 생성
- 예시 : `histogram_quantile(0.99, rate(apiserver_request_duration_seconds_bucket[5m]))`
  - `apiserver_request_duration_seconds_bucket` : API 서버의 응답 시간
  - `rate` : 히스토그램에서 관측하는 범위를 지정하기 위한 용도
  - `0.99` : API 서버 응답 시간이 99백분위수인 값을 찾음
  - `NaN` : 버킷으로 검출된 값이 없을 때 표시되는 값

<br>

### 히스토그램에 연산자 추가하기

- 예시 : `histogram_quantile(0.99, sum(rate(apiserver_request_duration_seconds_bucket[5m])) by (le))`
  - API 서버로부터 가장 느리게 응답받은 시간
  - `le` : Less Than Or Equal To

<br>
<br>

# 그라파나로 모니터링 데이터 시각화하기

- 메트릭 데이터를 시각화할 때 가장 많이 언급되는 도구
- 프로메테우스뿐만 아니라 엘라스틱서치, 인플럭스DB 등 여러 종류의 데이터 소스 시각화 가능
- 프로메테우스의 메트릭을 가져와서 메트릭 시각화를 실제로 구현해볼 것

<br>
<br>

## 헬름으로 그라파나 설치하기

※ grafana-install.sh

```sh
#!/usr/bin/env bash
helm install grafana edu/grafana \
--set persistence.enabled=true \
--set persistence.existingClaim=grafana \
--set service.type=LoadBalancer \
--set securityContext.runAsUser=1000 \
--set securityContext.runAsGroup=1000 \
--set adminPassword="admin"
```

- helm install
  - edu 저장소의 grafana 차트로 쿠버네티스 클러스터 위에 grafana 릴리스 설치
- persistence.enabled=true
  - 그라파나 디플로이먼트가 삭제되더라도 대시보드 데이터 유지를 위해<br>PVC를 통해 영구적으로 데이터를 저장하도록 설정
- persistence.existingClaim=grafana
  - 퍼블릭 클라우드의 PVC 동적 생성을 사용할 수 없는 가상 머신 환경이라는 문제
  - 그렇기 때문에 grafana라는 이름의 PVC를 사용하도록 설정
- service.type=LoadBalancer
  - 차트 설치 시 생성될 서비스 타입을 설정
  - LoadBalancer를 통해 MetalLB로부터 외부 IP 주소를 할당받도록 함
- securityContext
  - 사용자 ID와 그룹 ID를 1000번으로 설정

<br>
<br>

## 프로메테우스를 데이터 소스로 구성하기

**메뉴 살펴보기**

- Search
  - 사용자가 만든 대시보드를 태그 또는 이름으로 검색 가능
- Create
  - 가장 중요하고 많이 사용하는 메뉴
  - 새로운 대시보드 구성 및 다른 사람의 대시보드 추가 가능
  - 대시보드를 분류해서 관리하는 폴더도 여기서 설정
- Dashboards
  - 만들어진 여러 대시보드를 연결
  - 한 화면에 슬라이드 쇼처럼 확인할 수 있는 **Playlists**
  - 특정 시간의 대시보드 화면을 캡쳐 및 공유하는 **Snapshots**
- Explore
  - 데이터 소스를 선택해서 여러 표현식을 확인
  - PromQL 표현식 테스트 가능
- Alerting
  - 그라파나에서 경보를 보내기 위한 채널과 경보 규칙을 설정하는 메뉴
- Configuration
  - 대시보드 구성을 설정하는 하위 메뉴들
  - 주로 사용하는 메뉴는 **Data Sources**
  - **Plugins** : 대시보드의 기능 강화
  - **Teams / User** : 조직 구성
- Server Admin
  - 새로운 사용자 추가, 애플리케이션 상태와 설정값 확인
  - 주로 그라파나 관리자가 사용하는 메뉴
- Dashboard settings
  - Home을 설정할 수 있는 메뉴
  - 처음에는 홈 화면 설정 → 대시보드가 추가되면 추가된 대시보드 설정 가능
- Cycle view mode
  - 대시보드에 표시된 내용만 집중해서 볼 수 있는 모드로 변경하는 메뉴
  - 처음 한 번 누르면 왼쪽 메뉴가 사라지는 TV 모드
  - 한 번 더 누르면 위쪽 메뉴가 사라지는 kiosk 모드
  - 변환된 모드에서 `esc`를 누르면 다시 일반 모드

※ CoreDNS

- DNS 서비스를 제공하는 디플로이먼트
- DNS : Domain Name System
- 파드와 서비스가 배포될 때 IP 주소 정보와 도메인 이름을 자동으로 등록해서<br>도메인 이름으로 연결할 수 있도록 해줌
- IP로 직접 연결하기보다는 도메인 이름으로 구성해서 IP 변경 시 유연한 대처 가능
- 프로메테우스 도메인 확인 명령어
  - `kubectl run net --image=sysnet4admin/net-tools --restart=Never --rm -it -- nslookup 192.168.1.12`

<br>
<br>

## 노드 메트릭 데이터 시각화하기

- 그라파나는 대시보드를 만들고 그 안에 패널이라는 구성 요소를<br>추가하는 방식으로 메트릭 데이터를 시각화함

<br>

**New Panel > Panel 탭의 Visualization 항목**

- Graph
  - 그라파나에서 가장 많이 사용되는 기본 옵션
  - 점의 경로, 선, 막대로 데이터 시각화 가능
  - 대부분의 시계열 데이터를 사용자가 원하는 형태로 표시
- Stat
  - 특정 값과 함께 추이를 꺾은선 그래프로 나타내는 도구
  - 텍스트 모드를 통해 값만 볼 수도 있음
  - 주로 여러 대상이나 단일 대상의 상태를 나타내는 데 사용
- Gauge
  - 차량의 계기판 같이 값의 범위가 있는 데이터를 표현할 때 유용
  - 백분율처럼 사용량의 시작과 끝이 있을 때 사용
- Bar gauge
  - 게이지와 다르게 원형이 아닌 막대형으로 표현
  - 게이지보다 범위가 넓으므로 한계를 모르는 경우에 사용
- Table
  - 수집된 메트릭 데이터를 그대로 표현
  - 주로 실제 값을 대시보드에서 확인하는 목적
- Text
  - 제작자가 알리고 싶은 정보를 대시보드에 표현할 때 사용
  - 주로 대시보드의 목적과 사용법 등의 정보를 전달할 때 사용
- Heatmap
  - 패널을 다수 구역으로 나눠서 속하는 값이 많을수록 색상을 연하게 표현
  - 주로 히스토그램과 함께 빈도를 나타내는 용도
- Alert list
  - 수집 대상의 문제를 빠르게 확인하기 위한 정보 표시
  - 가장 최근 경보부터 확인 가능
- Dashboard list
  - 최근에 확인한 대시보드와 사용자가 즐겨찾기한 대시보드 등을 만들 때 사용
- News
  - RSS 피드와 같은 정보를 나타냄
  - 기본적으로 그라파나 공식 블로그의 게시글 정보 표시
- Logs
  - 외부 로그 데이터를 나타냄
  - 데이터 소스에서 받아온 로그 데이터를 시각화하는 데 사용
  - 로그 level에 따라 패널에 색상 변화를 넣을 수 있음
- Plugin list
  - 현재 설치된 플러그인 확인

<br>
<br>

## 파드 메트릭 데이터 시각화하기

- 파드 메트릭의 시각화 방법은 노드 메트릭의 시각화와 동일
- 그런데 파드는 여러 네임스페이스에 존재하니 사용자가 원하는 네임스페이스에 속한 파드만 확인하도록
- 그러기 위해서 변수를 선언하고, 변수로 원하는 내용만 선별해서 대시보드에서 확인하도록

<br>

**Dashboard settings > Variables > Add variable**

- Name
  - 대시보드에서 사용하는 변수 이름
  - 설정 후 앞에 `$`를 붙여서 사용 가능
- Label
  - 대시보드에서 변수 선택 시 변수를 지칭하는 레이블
- Data Source
  - 쿼리 실행 시 값을 받아오는 소스
- Refresh
  - 변수를 읽어들이는 방법 설정
- Query
  - 쿼리를 입력해서 그 결과를 그라파나 변수로 사용하도록 추가
- Include All option
  - 모든 네임스페이스를 선택할 수 있는 옵션
- Custom all value
  - 'Include All option' 활성화 시 추가되는 옵션
  - All 선택 옵션의 범위를 사용자가 지정 가능

<br>
<br>

# 좀 더 견고한 모니터링 환경 만들기

- 그라파나 대시보드를 항상 관찰하기보다는 알람 시스템이 있으면 좋을 것
- 대시보드를 공유해서 작성법을 몰라도 쓸 수 있게 하면 좋을 것

<br>
<br>

## 얼럿매니저로 이상 신호 감지하고 알려주기

- 경보 메시지 받는 방법
  - **그라파나의 얼럿 메뉴**
  - **프로메테우스의 얼럿매니저**
  - 그런데 그라파나의 얼럿 메뉴는 오직 시각화 그래프에만 존재하기 때문에 제한적

**Prometheus > Alerts**

- alert : 경보 메시지를 대표하는 이름
- expr : PromQL 표현식으로 경보 규칙을 설정해서 true인 경우 경보 발생
- for : 문제 지속 시간
- annotations : 하위 항목에 필요한 전달 메시지를 주석으로 기록
- description : 사용자 임의 지정 변수로 필요한 경보 내용 작성 가능

<br>
<br>

## 내가 만든 대시보드 공유하기

**Grafana > Share dashboard**

- Link
  - 다른 사용자가 대시보드에 접속할 수 있는 링크 주소와 옵션
- Snapshot
  - 대시보드의 현재 상태를 저장해서 대시보드에 접근할 수 없는 곳에서 확인 가능
- Export
  - 대시보드를 JSON 파일로 내보냄
  - JSON 파일은 그라파나 대시보드 저장소에 올리거나 다른 사용자에게 직접 전달할 수 있음
  - Export for sharing externally : 다른 사람이 만든 대시보드를 가져올 때 데이터 소스 선택

<br>
<br>

## 다른 사람이 만든 대시보드 가져오기

- https://grafana.com > Dashboards 탭 사용
