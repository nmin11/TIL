## crontab : 정기적인 작업을 자동으로 처리하고 싶어

- crond : 리눅스의 지정된 시각에 명령어를 자동 실행하는 서비스
- cronjob : crond로 실행하고 싶은 명령어와 실행 시각
- crontab : cronjob을 관리하는 명령어
- 등록된 cronjob 확인하기 : `sudo crontab -l`
- cronjob 표시 규칙
  - 예시 : `0 3 * * * /scripts/do_backup.sh`
  - 포인트는 분, 시, 일, 월, 요일
  - 시간은 24시간을 기준으로 표시
  - 요일은 일, 월, 화, 수, 목, 금, 토, 일을 0, 1, 2, 3, 4, 5, 6, 7로 표시 (일요일은 0과 7 모두 가능)
  - 즉, 위 예시는 매일 3시 정각에 실행됨
  - `30 2,14 * * * /scripts/do_update.sh` → 오전 2시와 오후 2시에 실행되도록 설정
- cronjob 설정하기
  - 명령어 : `crontab -e`
  - 스크립트를 실행해야 한다면 홈 디렉토리에서의 상대 경로 혹은 절대 경로를 사용해야 함
  - 환경 변수, 표시 화면, 사용자 조작의 차이로 잘 안 될 때가 있으므로 꼭 먼저 테스트해볼 것
  - `MAILTO=nmin1124@gmail.com` 열을 앞에 붙여서 출력 내용을 메일로 보낼 수도 있음
    - 단, MTA가 설정되어 있어야 함

<br>

## 공개키 인증 : 키 인증으로 안전하게 로그인하고 싶어

- 데이터를 공개키를 통해 암호화하고, 비밀키를 통해 복호화하는 방식
- 공개키를 공유하면 제3자는 비밀 정보를 안전하게 보낼 수 있게 되며,<br>비밀키를 가진 본인만 해당 정보를 확인할 수 있게 됨
- 암호 인증과 달리 비밀키 자체가 네트워크에 노출될 일이 없음
- key-pair 생성 방법
  - 명령어 `ssh-keygen` 입력
  - 비밀키의 passphrase 입력
    - 키 인증도 비밀키가 털리면 치명적이므로 한 번 더 암호화하는 과정

<br>

## 패스프레이즈 없는 비밀키

- cronjob에서 scp를 하려고 할 때 발생할 수 있는 문제점
  - scp를 하기 위해 접속하는 서버에 비밀키 패스프레이즈를 입력해야 함
- 이 문제를 해결하기 위해서 비밀키 패스프레이즈를 생략하기도 함
- 대신 해당 공개키 앞줄에 `command=(명령어)`를 적어서 특정 명령어만 사용할 수 있는 방식으로 설정
- 이후 `scp -i` 명령어를 통해 비밀키를 지정해서 실행하면 됨

<br>

## 처리 분산과 느슨한 결합 연계 : 여러 서버에 있는 파일을 효율적으로 수집하고 싶어

- 자동 인증으로 scp하려면 다운로드 허가 대신 업로드 허가를 하는 편이 안전
- 처리 크기는 작게, 처리 사이는 느슨한 결합으로, 커다란 문제는 작은 문제로 쪼개서 생각하기
- 여러 서버가 엮인 처리 과정은 각 서버 단위에서 처리가 완료되도록 해서 서버끼리의 통신 줄이기

<br>

## wc와 산술 확장 : 조건에 해당하는 로그 줄 수를 집계하고 싶어

- Word Count의 약자
- 지정한 파일이나 파이프라인으로 넘어온 내용의 문자수와 줄 수를 세서 그 결과를 돌려줌
- `wc -l` 또는 `wc --lines` : 줄 수 출력
- `wc -w` 또는 `wc --words` : 단어수 출력
- `wc -m` 또는 `wc --chars` : 문자수 출력

※ 예시 : 2022년 3월 20일에서 4월 10일까지의 로그 집계하기

```sh
#!/bin/bash

total_count=0
for log in /oldlog/2014/access.*.gz
do
  pattern="([23][0-9]/Mar|(0[0-9]|10)/Apr)/2022"
  count=$(zcat $log | grep "/campaign" | grep -E $pattern | wc -l)
  total_count=$(($total_count + $count))
done
echo "合計 : ${total_count}"
```

- `$(())` 안에는 계산식을 넣을 수 있음

<br>

## sed : 여러 텍스트 파일을 일괄 편집하고 싶어

- Stream Editor의 약자
- gedit이나 vim은 실시간 대화식으로 편집하는 스크린 에디터
- sed는 텍스트를 어떻게 편집할지를 명령줄 옵션으로 지정해서 지시하는 방식
- `-e` 또는 `--expression` 옵션 하나가 sed에 대한 하나의 지시가 됨
  - 이 옵션은 여러 번 사용 가능
- 일괄 치환 예시 : `sed -e "s/치환전 문자열/치환후 문자열/"`
- 주의사항 : sed 작업 후 리다이렉트해서 저장하려고 할 때,<br>같은 파일을 동시에 작업하려고 하면 충돌이 발생해서 파일이 지워질 수 있음
  - 그러므로 변경 전에 파일을 백업해두고 백업에서의 작업을 원본으로 리다이렉트할 것
- `-i` 옵션으로 파일 저장 가능
  - 옵션 뒤에 확장자명 지정 가능

※ 예시

```sh
#!/bin/bash
for file in *.csv
do
  backup=${file}.$(data +%Y-%m-%d).bak
  mv $file $backup
  cat $backup | sed -e "s/반환중/회수완료/" $file
done
```

※ 스크린 에디터와 스트림 에디터 외에 명령어를 써서 줄 단위로 텍스트를 편집하는 라인 에디터가 있음

- 전자계산기처럼 한 줄만 출력되는 디스플레이를 사용하거나<br>한 줄만 인쇄되는 프린터를 디스플레이 대신에 사용할 때 한 줄씩 대화식으로 편집 가능
- 단말에서 `ed` 명령어를 실행하면 써볼 수 있음
