## IP 주소를 고정하는 전통적인 설정 방법

- IPv4는 2진수로 32자리 숫자가 할당된 식별자
  - 보통 사용하는 IP 주소는 이 IPv4를 10진수로 표현한 방식
  - 2진수 표기 예시 : `11000000 10101000 00001010 00000000`
  - 10진수 표기 예시 : `192.168.10.0`
- 네트워크 세그먼트 : IPv4는 이론상 2³²개의 경우의 수를 가질 수 있으니<br>이를 작은 단위로 나눠서 관리하기 위한 방법
  - 서브넷 마스크 : 세그먼트 범위 안에서 IP 주소가 변하는 부분과 변하지 않는 부분을 나타낸 것
  - 예시로 `255.255.255.0`은 맨 뒤 8개의 2진수들만 변경할 수 있는 범위이고,<br>나머지 부분은 고정되어 있음
- 네트워크 설정 방법
  - **nmcli** 명령어를 사용하는 방법이 간단하기는 함
  - 우분투, 데비안은 버전에 따라 최소 구성만 한다면 nmcli 미설치
  - 레드햇, CentOS는 버전 7 이후 nmcli 설치 추천
- 전통적인 고정 IP 주소 설정 방법
  - 데비안 계열 : /etc/network/interfaces
  - 레드햇 계열 : /etc/sysconfig/network-scripts/ifcfg-(인터페이스명)
  - eth0 : 네트워크 접속용 인터페이스 이름
  - wlan : 무선 접속용 인터페이스
  - address : 고정할 IP 주소 명시
  - gateway : 라우터 IP 주소이며, IP 주소를 고정할 때 라우터도 명시적으로 지정해야 함
  - 새로운 설정 적용 예시 : `ifdown eth0` 이후 `ifup eth0`

※ 데비안 예시

```bash
auto lo
iface lo inet loop back

auto eth0
iface eth0 inet static
address 192.168.10.100
netmask 255.255.255.0
gateway 192.168.10.1
```

※ 레드햇 예시

```bash
TYPE=Ethernet
DEVICE=eth0
ONBOOT=yes
BOOTPROTO=none
IPADDR=192.168.20.101
NETMASK=255.255.255.0
GATEWAY=192.168.20.1
```

<br>

## ufw를 사용한 방화벽 설정 : 특정 포트에만 접속 허가하고 싶어

- 방화벽을 설정하기 위해 리눅스는 전통적으로 iptables를 사용하지만<br>우분투라면 ufw 명령어가 간단하며, 다른 배포판에서도 `apt-get install ufw`로 설치 가능
- `ufw` 사용 방법
  - `ufw status` : 현재 설정된 방화벽 내용 확인
  - `ufw default deny`로 모든 포트에 대한 접속을 금지하고<br>`ufw allow 80`을 입력해서 원하는 포트 개방<br>설정을 마치고 나면 `ufw enable`로 방화벽 활성화
  - 리모트 접속을 하고 싶다면 ssh 접속 기본값인 22번 포트도 꼭 열어둘 것
  - `ufw reload` : 이미 방화벽이 활성화된 상태에서 변경된 내용을 적용할 때 사용

<br>

## iptables : CentOS 6 이전 버전에서의 방화벽

- `ufw`가 간단하면서도 잘 정제된 느낌이라면, `iptables`는 직접 만들기 위한 공구 상자의 느낌
- `ufw`에선 자동으로 해주던 부분들도 직접 구성해야 하니 설정이 좀 더 복잡하고 까다로움
- CentOS 7 이후 방화벽은 `firewalld`로 설정

※ firewalld 설정 예시

```bash
systemctl start firewalld
systemctl enable firewalld
firewall-cmd --set-default-zone=public
firewall-cmd --add-port=80/tcp --zone=public --permanent
firewall-cmd --add-port=22/tcp --zone=public --permanent
firewall-cmd --remove-port=80/tcp --zone=public --permanent
firewall-cmd --reload
```

<br>

## 접속 상대에 따라 통신 허가, 차단을 판단하는 방화벽 설정

- `ufw`의 본래 사용법
  - `ufw allow from (허가하고 싶은 통신의 접속해온 주소) to (허가하고 싶은 통신의 대상 주소)`
  - 예시 : `ufw allow from 192.168.40.0/24 to any port 80`
  - `any`는 port 80이 아니라 IP 주소에 대한 허용 설정

※ firewalld 접속 상대별 방화벽 설정 예시

```bash
firewall-cmd --zone=trusted --add-source=192.168.40.0/24  --permanent
firewall-cmd --zone=trusted --add-port=80/tcp             --permanent
firewall-cmd --zone=trusted --add-port=22/tcp             --permanent
firewall-cmd --zone=public  --add-source=192.168.11.0/24  --permanent
firewall-cmd --zone=public  --add-port=22/tcp             --permanent
firewall-cmd --default-zone=drop
firewall-cmd --reload
```

- firewalld에서는 **zone** 단위로 설정하는 것이 기본임
- trusted, public이라는 이름의 zone이 있어서, zone마다의 규칙에 따라 어떻게 할 것인지 판단

<br>

## 에이전트 전송을 사용한 ssh로 공개키 인증

- ssh로 원격 조작하는 컴퓨터에서 또 다른 컴퓨터로 접속할 수 있음
- 그런데 이 때 사용하던 키 인증이 있다면 중간 서버에서 비밀키를 입력해야만 함
- 이럴 때 사용하는 것이 **Agent Forwarding**
- ssh 에이전트
  - 키 인증이 필요한 서버에 로그인할 때 패스 프레이즈 입력 한번으로,<br>이후에도 재로그인이 가능하게 도와주는 서비스
  - 사용자가 패스 프레이즈를 입력해서 락을 해제한 후의 비밀키를 지니고 있음
  - 비밀키가 필요해지면 가지고 있던 락 해제된 비밀키를 자동으로 사용
  - 그리고 여러 중간 서버를 거치는 인증에서도 비밀키를 전달해줄 수 있음
  - 사용 방법 : `ssh -A`

※ 에이전트 전송을 신뢰할 수 있는 서버 등록하기

- ~/.ssh/config에 텍스트 파일 작성

```bash
Host FileServer
HostName 192.168.1.10
ForwardAgent yes

Host InternalWebServer
HostName 192.168.1.20
ForwardAgent yes
```

<br>

## ssh 포트 전송 : 로컬 전송 기초

- 터널링 : VPN처럼 기존 통신 위에 가상 통신 경로를 만들어서 별도로 통신하도록 하는 것

※ 사용 예시

```bash
ssh mint@192.168.1.100
  -L 50022:192.168.2.20:22
```

- `-L`은 local, 즉 로컬에서 리모트로 통신 경로를 만드는 것
- `50022`는 원본 컴퓨터에서 터널 입구로 사용할 포트 번호로,<br>비어 있는 포트인 49152번부터 65535번 사이의 포트 번호를 사용한 것
- `192.168.2.20:22`는 터널 출구로, 대상 서버의 IP 주소와 포트 번호 입력
- 이렇게 입력한 이후에는 새로운 터미널을 열어서 복사와 같은 작업을 진행해야 함

※ 활용 예시

```bash
scp -P 50022
  /mnt/media/centos.iso
    admin@localhost:/tmp/
```

- 이렇게 하면 우선 자신의 로컬에서 50022번 포트를 향하게 됨
- 이후 미리 지정한 중간 서버 출구를 통해 `192.168.2.20:22`에 도착
- 중간 서버는 단순히 통신을 포트에서 포트로 넘겨주므로 디스크 빈 공간을 확인할 필요가 없음
- 포트끼리 통신을 직접 전송하므로 **Port Forwarding**이라고 부름
- 혼란스럽지 않도록 미리 통신 흐름을 계획해두는 것이 포인트

※ 로컬 루프백 주소란?

- IP 주소 중에서도 해당 컴퓨터 자체를 가리키기 위해 미리 예약해둔 특별한 범위의 IP 주소
- 127.0.0.1부터 127.255.255.255 사이의 16777216개
- 네트워크 주소로는 127.0.0.0/8 범위의 IP 주소
- 보통은 127.0.0.1을 많이 사용하지만 여러 컴퓨터를 시뮬레이션하기 위해 다른 주소를 사용할 때도 있음
- 그러나 IPv6에서는 쓸모가 없다고 판단하여, 0:0:0:0:0:0:0:1(단축 표기는 ::1) 단 하나만 두었음

<br>

## ssh 포트 전송 : 로컬 전송 응용

- 터널링은 단순히 scp만을 위한 기능은 아님
- 전송 대상 포트 번호를 바꾸면 다양한 서비스에서 이용 가능
- **어떤 등장인물**이 있고, **어떤 통신**을 하고 싶은가를 정리하는 것이 포인트!
- 등장인물이 최종 목적지에서 출발지점을 향해 반대 순서로 생각하면 이해하기 편함

※ 사용 예시

```bash
ssh admin@192.168.40.101
  -L 50080:192.168.1.103:80 -g
```

- `-g`는 gateway ports의 약자로 터널 입구가 다른 컴퓨터에서도 터널 입구 개방

※ 서버 자체에 ssh 접속해서 해당 컴퓨터의 localhost로 통신하는 것도 가능

```bash
ssh admin@192.168.1.103 -L 50080:localhost:80
```

<br>

## autossh 자동 재접속

- 단순히 `ssh`를 `autossh`로 바꿔주면 됨
- 인수나 옵션 지정은 기본적으로 `ssh`와 동일
- 다만 기본 설치가 아니므로 `sudo apt-get install autossh` 같은 명령어로 설치해야 함

<br>

## lsof, 서비스명으로 포트 번호 특정

- CentOS 최소 구성이라면 설치되어 있지 않으니 `yum install lsof` 등으로 설치 필요
- **Address already in use**라는 에러 메시지는 사용하려 한 포트가 이미 사용 중이라는 뜻
- 3000번 포트를 사용 중인 프로세스를 알기 위해 `lsof -i :3000` 명령어 사용
- 그런데 사실 `lsof`의 본래 역할은 프로세스가 열고 있는 파일을 조사하거나,<br>반대로 파일을 열고 있는 프로세스를 조사하는 것
  - 예시 1 : `lsof -p 1019`
  - 예시 2 : `lsof /path/to/file`
  - 이는 리눅스에서 각종 정보 입출력을 **읽고 쓰는 방식**으로 다루기 때문에<br>마치 파일과 같은 취급이 가능해진 것
- 특정 포트 사용 상황 조사하기
  - 예시 1 : `lsof -i :3000`
  - 예시 2 : `lsof -i4 TCP@192.168.1.123:3000`
  - 중요한 산출값은 COMMAND, PID, NAME<br>COMMAND는 명령어, PID는 프로세스 ID, NAME은 LISTEN에 해당하면 통신 대기중

※ 반대로 프로세스 ID를 알 때 해당 프로세스가 사용하는 포트 번호 알아내는 예시

```bash
lsof -p 18079 -P | grep LISTEN
```

<br>

## nethogs, iftop : 누가 네트워크 영역을 사용하고 있는지 알고 싶어

- 두 명령어는 공통적으로 설치가 필요하며, 또한 관리자 권한이 필요함
- nethogs : 어떤 프로세스의 통신량이 많은지 조사할 때 사용
- iftop : 어떤 통신 상대와 통신량이 많은지 조사할 때 사용
- 통신량이 많은 서비스를 특정했다면 해당 서비스의 로그를 확인할 것
