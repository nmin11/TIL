## Overview

- AWS Lambda + API Gateway => no infrastructure to manage
- WebSocket Protocol 지원
  - 실시간 스트리밍 가능
- Handle API versioning
- Handle different environments
- Handle security
  - Authentication and Authorization
- API key 생성 및 request throttling 관리
- Swagger / Open API를 사용해서 API를 빠르게 정의
- Transform and validate requests and responses
- Generate SDK and API specifications
- Cache API responses

### Integrations High Level

- Lambda Function
  - invoke Lambda function
  - Lambda로 작동되는 REST API를 노출하기 위한 쉬운 방법
- HTTP
  - backedn에서 어떤 HTTP endpoints라도 노출할 수 있음
  - rate limiting, caching, user authentications, API keys 등을 위해
- AWS Service
  - 모든 AWS API를 노출할 수 있음
  - authentication, deploy publicly, rate control 등을 위해

### Endpoint Types

**Edge-Optimized (default)**

- for global clients
- latency를 줄이기 위해, 모든 요청은 CloudFront Edge Location을 통해서 routed
  - 그럼에도 API Gateway는 한 region에만 남아있음

**Regional**

- for clients within the same region
- 수동으로 CloudFront와의 연동 가능
  - Edge-Optimized에 비해 caching strategies 및 distribution에 대한 제어를 더 할 수 있음

**Private**

- 자체 VPC 내에서만 access 가능
- ENI(Elastic Network Interface)를 사용하게 됨
- resource policy를 정의하고 access

<br>

## Deployment Stages

- API Gateway를 변경만 할 것이 아니라 "deployment"를 해야 효과가 나타남
- 변경사항들은 "Stages"에 배포됨
  - 원하는 만큼 단계들을 가질 수 있음
  - 각 stage는 자체 configuration parameters가 있음
  - history를 참조해서 stages를 roll back 할 수 있음

### Stage Variables

- API Gateway만의 환경변수 느낌
- 자주 바뀌는 configuration values를 위해 사용됨
- They can be used in :
  - Lambda function ARN
  - HTTP Endpoint
  - Parameter mapping templates
- Use cases :
  - HTTP endpoints를 각 stage 별로 구성하는 경우
  - Lambda로 configuration parameters를 전송하는 경우
- stage variables는 AWS Lambda에 "context" 객체로 전달됨

<br>

## Canary Deployment

- 소량의 트래픽으로 테스트하는 방법
- 주로 prod 환경에서 사용
- canary channel receives에 대한 % 지정
- 5% 정도로 작은 트래픽만 테스트해보다가 테스트가 완료되면 100%의 트래픽을 보내도록 적용
- 모니터링을 위해 Metrics & Logs 분리
- canary를 위해 stage variable 재정의 가능
- 마치 AWS Lambda, API Gateway와 함께 blue / green deployment를 하는 것과 같음

<br>

## Integration Types

**MOCK**

- backend로 요청을 보내지 않고 응답을 반환
- 개발 및 테스트 용도

**HTTP / AWS (Lambda & AWS Services)**

- 반드시 request와 response에 대한 integration을 구성해야 함
- **mapping templates**를 사용해서 data mapping 설정 가능

**AWS_PROXY (Lambda Proxy)**

- client의 request가 Lambda의 input이 됨
- request와 response 수정 불가
- responsible for the logic of request / response
  - mapping template, headers, query string parameters 같은 걸 지정할 수 없고, 함수에 arguments로 직접 전달

**HTTP_PROXY**

- no mapping template
- HTTP request는 backend로 직접 전달
- backend로부터의 응답을 다시 proxy

<br>

## Mapping Templates

- request / response 수정을 위해 사용
- query string parameters 수정
- body content 수정
- add/modify headers
- Velocity Template Language (VTL)
  - 일부 request를 수정하는 script 언어
  - for loop, if 등을 지원
- response에서 일부 불필요한 데이터 삭제
