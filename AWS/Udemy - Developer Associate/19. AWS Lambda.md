## What's serverless?

- 개발자들이 서버를 관리하지 않는다는 새로운 paradigm
- 그저 코드(기능)(함수)를 배포
- 초기에는 `Serverless == FaaS(Function as a Service)`
- 지금은 DB, 메시징, 스토리지 등 원격으로 관리되는 것들을 포함하는 개념
- 서버가 아예 없다는 건 아님
  - 관리하지 않아도 되고, provision도 없고, 보이지 않을 뿐

<br>

## Serverless in AWS

- AWS Lambda
- DynamoDB
- AWS Cognito
- AWS API Gateway
- Amazon S3
- AWS SNS & SQS
- AWS Kinesis Data Firehose
- Aurora Serverless
- Step Functions
- Fargate

<br>

## Why AWS Lambda

- virtual functions - 관리할 서버가 없음
- limited by time - 짧은 실행 시간
- run on-demand
- scaling is automated
- easy of pricing
  - 요청 횟수 및 compute time에 따라 청구
  - free tier의 경우 1,000,000건의 요청과 400,000GB의 compute time 제공
  - https://aws.amazon.com/ko/lambda/pricing/
- 다양한 AWS 서비스들과의 integration
- 다양한 programming languages와의 integration
- CloudWatch 모니터링에 용이
- 함수에 더 많은 리소스를 부여할 수 있음 (최대 10GB RAM)
- RAM 성능을 높이면 CPU 및 네트워크 성능도 향상

<br>

## AWS Lambda language support

- Node.js (JavaScript)
- Python
- Java (8 or 11)
- C# (.NET Core) (Powershell)
- Golang
- Ruby
- Custom Runtime API (커뮤니티에서 지원하는 오픈소스 런타임이 있음)
- Lambda Container Image
  - 컨테이너 이미지 자체가 Lambda Runtime API를 구현해야 함
  - ECS / Fargate는 임의의 Docker images를 실행하는 데 사용됨

<br>

## Synchronous Invocations

- CLI, SDK, API GW, ALB 사용은 모두 동기식 호출을 사용하던 것
  - 결과를 기다리고 있으면 반환값이 돌아오는 방식
  - error handling은 반드시 client side에서 해결해야 함
    - 재시도, exponential backoff 등

### Services

- **User Invoked**
  - Elastic Load Balancing (Application Load Balancing)
  - API Gateway
  - CloudFront (Lambda@Edge)
  - S3 Batch
- **Service Invoked**
  - Cognito
  - Step Functions
- **Other Services**
  - Lex
  - Alexa
  - Kinesis Data Firehose

<br>

## Integration with ALB

- Lambda function을 HTTP(S) endpoint로 노출시키기 위한 작업
- Application Load Balancer (혹은 API Gateway)를 사용하는 방법
- Lambda function을 **target group**에 등록해야 함
- ALB의 Lambda function 호출은 동기식

### ALB to Lambda: HTTP to JSON

※ Request Payload for Lambda Function

```json
{
  "requestContext": {
    "elb": {
      "targetGroupArn": "arn:aws:elasticloadbalancing:us-east-2:123456789"
    }
  },
  "httpMethod": "GET",
  "path": "/lambda",
  "queryStringParameters": {
    "query": "1234ABCD"
  },
  "headers": {
    "connection": "keep-alive",
    "host": "lambda-elb-123456789.us-east-2.elb.amazonaws.com",
    "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)",
    "x-amzn-trace-id": "Root=1-123456789-abcdefghi",
    "x-forwarded-for": "12.34.567.890",
    "x-forwarded-port": "80",
    "x-forwarded-proto": "http"
  },
  "body": "",
  "isBase64Encoded": false
}
```

- 어떤 ELB가 호출하는지, target group은 무엇인지 담겨 있음
- HTTP 메소드, 경로, query string, 헤더, 바디 등 HTTP 요청에 필요한 정보들을 JSON으로

### Lambda to ALB conversions: JSON to HTTP

※ Response from the Lambda Function

```json
{
  "statusCode": 200,
  "statusDescription": "200 OK",
  "headers": {
    "Content-Type": "text/html; charset=utf-8"
  },
  "body": "<h1>Hello world!</h1>",
  "isBase64Encoded": false
}
```

- HTTP 응답에 맞는 상태 코드, 헤더, 바디 등의 정보들

### ALB Multi-Header Values

- ALB setting: ALB가 multi header values를 지원하도록 해줌
- 이를 활성화하면 HTTP 헤더들과 query string 매개변수들은 배열로 표현됨

```json
"queryStringParameters": {"name": ["foo", "bar"]}
```

<br>

## Lambda@Edge

- CloudFront CDN을 통해 세계 각지에 Lambda function 배포
  - 즉각 반응하는 애플리케이션을 만들기 위함
  - 우리가 서버를 관리하지 않고도 Lambda는 전 세계에 배포됨
  - CDN에 있는 모든 컨텐츠를 수정할 수 있음
  - 사용한 것에 대한 비용만 지불
- CloudFront 요청과 응답을 바꾸기 위해 사용됨
  - viewer request: CloudFront가 viewer로부터 요청을 받고 해당 요청을 수정
  - origin request: CloudFront가 origin으로 요청을 전달하기 이전의 수정
  - origin response: origin으로부터 응답을 받은 이후 해당 응답을 수정
  - viewer response: viewer에게 응답해주기 전에 응답을 수정
  - origin에 대한 요청을 보내지 않고도 viewer에게 응답을 생성해줄 수도 있음

### Use Cases

- Website Security and Privacy
- Dynamic Web Application at the Edge
- SEO (Search Engine Optimization)
- Intelligently Route Across Origins and Data Centers
- Bot Mitigation at the Edge
- Real-time Image Transformation
- A/B Testing
- User Authentication and Authorization
- User Prioritization
- User Tracking and Analytics

<br>

## Asynchronous Invocations

- 이벤트는 **Event Queue** 안에 위치하게 될 것
- Lambda는 이벤트 처리 중 문제가 생기면 자동으로 retry
  - 3 tries total
  - 첫번째는 즉시
  - 두번째는 첫번째의 1분 뒤에
  - 세번째는 두번째의 2분 뒤에
- 재시도할 때를 위해서 Lambda가 반드시 **idempotent**를 갖추도록 해야 함
  - idempotent: 여러 번 실행해도 같은 결과가 나온다는 멱등성
- Lambda가 재시도되었을 때, CloudWatch Logs에 logs entries가 복제됨
- SNS 혹은 SQS의 DLQ(Dead-Letter Queue)를 재시도 작업 실패를 위해서 정의할 수 있음
  - IAM permission 필요

### Services

- S3
- SNS
- EventBridge / CloudWatch Events
- CodeCommit (CodeCommit Trigger: new branch, new tag, new push)
- CodePipeline (invoke a Lambda function during the pipeline)
- CloudWatch Logs (log processing)
- Simple Email Service
- CloudFormation
- Config
- IoT / IoT Events

<br>

## Integration with EventBridge / CloudWatch Events

※ 예시

- Cron or Rate EventBridge Rule을 생성해서 주기적으로 Lambda 트리거링
- CodePipeline EventBridge Rule으로 파이프라인의 State Changes마다 Lambda 트리거링

<br>

## S3 Events Notifications

- S3 이벤트 알림들
  - S3:ObjectCreated
  - S3:ObjectRemoved
  - S3:ObjectRestore
  - S3:Replication
- prefix와 suffix로 필터링 가능
- S3 이벤트는 SNS, SQS, Lambda로 전송될 수 있음
- S3 이벤트 알림은 보통 몇 초 이내에 전송되지만 가끔 1분 이상이 걸릴 수 있음
- 이벤트 알림을 하나도 놓치고 싶지 않다면 버켓 버저닝을 활성화해야 함
  - 2개의 객체를 동시에 쓰는 경우
