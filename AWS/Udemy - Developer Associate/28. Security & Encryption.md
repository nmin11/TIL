_KMS, Encryption SDK, SSM Parameter Store_

## Encryption

### Encryption in flight (SSL)

- data는 client의 전송 전 encrypted, server에서 수신 후 decrypted
- SSL certificates는 암호화를 도움 (HTTPS)
- MITM(man in the middle attack) 방지

### Server side encryption at rest

- data는 server가 수신 후 encrypted, 다시 client로 보내기 전 decrypted
- data는 key와 함께 암호화된 형식으로 저장됨
- encryption / decryption keys는 반드시 KMS로 관리되어야 한
- server는 반드시 KMS에 access할 수 있는 권한이 있어야 함

### Client side encryption

- data는 client에 의해 encrypted, server의 decrypted 과정 없음
- data를 수신하는 client에 의해 decrypted
- Envelope Encryption 활용

<br>

## KMS (Key Management Service)

- AWS에서 "encryption"에 대한 이야기가 나온다면 대부분은 KMS를 말하는 것
- data access 과정을 쉽게 하기 위해, AWS가 keys를 관리해줌
- Fully integrated with IAM for authorization
- 다른 서비스들과의 통합 지원
- SDK, CLI와도 함께 사용 가능

### CMK (Customer Master Key) Types

**Symmetric (AES-256 keys)**

- encrypt / decrypt 를 위한 single encryption key
- AWS의 많은 서비스들이 KMS와 통합되어 있기에, 내부적으로 많이 사용되는 type
- envelope encryption에도 필요
- 사용을 위해 반드시 KMS API를 호출해야 함
- Able to fully manage the keys & policies
  - Create / Rotation policies / Disable / Enable
- Able to audit key usage (using CloudTrail)
- CMK의 3가지 종류:
  - AWS Managed Service Default CMK: free
  - User Keys created in KMS: $1 / month
  - User Keys imported (must be 256-bit symmetric key): $1 / month
- \+ KMS API를 호출할 때마다 비용 부과 ($0.03 / 10000 calls)

**Asymmetric (RSA & ECC key pairs)**

- Public(Encrypt) and Private(Decrypt) key pair
- encrypt - public key / decrypt - private key
- sign - public key / verify - private key
- public key는 downloadable, private key에 대한 access 불가
- use case: KMS API를 호출할 수 없는 사용자가 AWS 외부에서 암호화를 하려는 경우

### KMS Usage Guide

- 민감한 정보를 공유할 때 사용
  - DB password
  - 외부 서비스 credentials
  - SSL certificates의 private key
- 사용자는 CMK encrypt data를 볼 수 없고, 보안은 AWS에 의해 관리됨
- 호출당 4KB의 data 암호화 가능
  - 4KB를 넘을 경우 envelope encryption을 사용해야 함
- 다른 사람에게 KMS access를 주는 방법:
  - Key Policy가 사용자를 허용하도록 해야 함
  - IAM Policy가 API 호출을 허용하도록 해야 함

### KMS Key Policies

- Control access to KMS keys

**Default KMS Key Policy**

- 특정한 KMS Key Policy를 제공하지 않았을 때 생성됨
- root user에게 access 권한 부여
- 다른 users에게 권한을 부여하려면 IAM policies를 만들어서 해당 user와 연결하면 됨

**Custom KMS Key Policy**

- KMS key에 access할 수 있는 users, roles 정의
- KMS key에 대한 administer 정의
- cross-account access를 해두면 편리

### Copying Snapshots across accounts

1. snapshot 생성 → CMK에 의한 encrypted
2. KMS Key Policy를 연결해서 교차 계정 간 access 허용
3. encrypted snapshot 공유
4. (in target) snapshot에 대한 복사본 생성 → 해당 계정의 KMS key와 함께 암호화
5. snapshot을 위한 volume 생성

※ KMS Key Policy

```json
{
  "Sid": "Allow use of the key with destination account",
  "Effect": "Allow",
  "Principal": {
    "AWS": "arn:aws:iam::TARGET-ACCOUNT-ID:role/ROLENAME"
  },
  "Action": ["kms:Decrypt", "kms:CreateGrant"],
  "Resource": "*",
  "Condition": {
    "StringEquals": {
      "kms:ViaService": "ec2.REGION.amazonaws.com",
      "kms:CallerAccount": "TARGET-ACCOUNT-ID"
    }
  }
}
```

### Feature - Data Key Caching

- 매번 object를 암호화할 때마다 data key를 재생성하는 것이 아니라 재사용
- KMS 호출 횟수를 줄일 수 있지만 보안 측면에서는 trade-off가 있음
- LocalCryptoMaterialsCache를 사용해서 cache 관리 가능
  - max age, max bytes, max number of messages

### KMS Symmetric API

**Encrypt**

- 최대 4KB의 data encrypt

**GenerateDataKey**

- Envelope Encryption을 위해 사용됨
- unique symmetric data key 혹은 DEK(Data Encryption Keys) 생성
- returns a plaintext copy of the data key
- CMK의 copy도 반환 가능

**GenerateDataKeyWithoutPlaintext**

- DEK를 활용하기 위해서 생성하지만 즉시 사용되지 않고 특정 point에서 사용됨
- 우리가 특정한 CMK로 encrypt
- decrypt는 반드시 나중에 이뤄져야 함

**Decrypt**

- 최대 4KB의 data를 decrypt (including DEK)

**GenerateRandom**

- returns a random byte string
