## RDS(Relational Database Service) Overview

- 관계형 데이터베이스 서비스를 나타냄
- SQL을 쿼리 언어로 사용하는 DB를 위한 관리형 DB
- 클라우드에 데이터베이스를 생성할 수 있으며, 이는 AWS 상에서 관리됨
- AWS에서 관리하는 엔진 타입
  - Postgres
  - MySQL
  - MariaDB
  - Oracle
  - Microsoft SQL Server
  - Aurora (AWS Proprietary database)

### DB를 EC2에 설치하지 않고 RDS를 사용했을 때의 이점

- 관리형 서비스이기 때문
  - AWS가 데이터베이스 뿐만 아니라 각종 기타 서비스들을 제공
  - 프로비저닝 완전 자동화 및 기본 운영체제 패치 자동화
  - 지속적인 백업 수행
    - 특정 timestamp로 복구 가능하며, 이를 PITR(Point In Time Restore)이라고 부름
  - Monitoring dashboard를 통해서 DB 성능 확인 가능
  - 읽기 성능 향상을 목적으로 하는 읽기 전용 복제본
  - DR(Disaster Recovery)을 위한 multi AZ 설정 가능
  - 업그레이드를 위한 유지보수
  - scaling capacity (vertical and horizontal)
  - 스토리지는 EBS 기반 (gp2 or io1)
- 하지만 RDS 인스턴스를 위한 SSH를 따로 가질 수는 없음

### RDS Backups

- RDS에서 자동으로 활성화
- 자동으로 백업
  - 정의해 놓은 유지 관리 기간 동안 매일 수행되는 DB 전체에 대한 백업
  - 일일 트랜잭션 로그가 매 5분마다 RDS에 백업
  - 위 2가지를 활용해서 그 어떤 지정 시점으로든 DB를 복원할 수 있음
  - 자동 백업은 기본적으로는 7일 보관 (최대 35일까지 연장 가능)
- DB Snapshots
  - 사용자가 수동으로 발동시키는 백업
  - 백업 보관 기간을 사용자가 임의로 설정할 수 있음

### RDS - Storage Auto Scaling

- RDS DB 생성시 원하는 스토리지 용량을 지정해야 함
- DB 사용량이 많고 가용 공간이 부족해지는 경우 Storage Auto Scaling 기능이 활성화되어 있으면<br>RDS가 이를 감지해서 자동으로 스토리지에 대한 스케일링 수행
- DB 스토리지를 수동으로 확장하는 일이 없도록 하는 것이 핵심
- 이를 위해서 **Maximum Storage Threshold**를 설정해야 함
- 스토리지 자동 수정 예시
  - 가용 스토리지가 10% 미만으로 떨어졌을 때
  - 낮은 스토리지 용량이 5분 이상 지속되었을 때
  - 마지막 수정 이후 6시간이 지났을 때
- 예측 불가능한 workload들에 유용
- MariaDB, MySQL, PostgreSQL, SQL Server, Oracle 등 모든 RDS DB 엔진 지원

<br>

## RDS Read Replicas & Multi AZ

⭐ 시험을 위해 읽기 전용 복제본과 다중 AZ의 차이를 이해하고 전용 사례를 알아야 함!

### RDS Read Replicas

- 최대 5개의 Read Replicas 생성 가능
- Within AZ, Cross AZ, Cross Region
- 복제는 **ASYNC**로 이루어지므로, 읽기 작업이 일관적으로 유지됨
- 복제본은 그들만의 DB로 승격할 수 있음
  - 복제 후 복제본은 복제 메커니즘을 완전히 탈피
- Read Replicas를 사용할 때 애플리케이션은 반드시 모든 연결을 업데이트해야 함

### Read Replicas - Use Cases

- 평균적인 로드를 감당하고 있는 생산 DB가 있을 때
  - 인스턴스에 대한 읽기 및 쓰기 수행
  - 그런데 만약 데이터를 기반으로 몇 가지 보고와 분석을 실시한다고 하면?
  - 보고 및 분석을 실제 DB에서 실행하면 오버로드가 발생하고 애플리케이션의 속도가 느려질 것
  - 보고 및 분석을 할 새로운 workload에 대한 Read Replicas를 생성하면 해결됨
- Read Replicas는 오직 `SELECT` 명령문만 사용할 수 있음을 명심해야 함

### Read Replicas - Network Cost

- AWS에서는, 통상적으로 다른 AZ로 데이터가 넘어갈 때 비용이 발생
- 하지만 예외가 존재하며, 이 예외는 보통 관리형 서비스에서 나타남
- RDS Read Replicas는 관리형 서비스
  - Read Replicas가 동일 Region에 있으며 다른 AZ에 있을 때는 비용이 발생하지 않음
  - 다른 Region에 있는 경우에는 네트워크에 대한 복제 비용 발생

### RDS Multi AZ (Disaster Recovery)

- RDS Master DB를 다른 AZ의 standby DB로 **SYNC** 복제
  - Master DB에 쓰이는 모든 것들이 인스턴스에도 그대로 복제된다는 뜻
- 하나의 DNS 이름을 가짐
  - Master에 문제가 생기면 자동으로 standby DB에 장애 조치가 수행됨
- 이를 통해 가용성을 높일 수 있음
- AZ 전체 또는 네트워크가 손실될 때에 대비한 장애 조치
- 앱에 수동으로 조치를 취할 필요가 없음
- scaling을 위해 사용되지 않으며, 오직 대기 목적만을 수행
  - 누구도 읽고 쓸 수 없음
- ⭐ Read Replicas 또한 DR을 위한 Multi AZ로 설정될 수 있음

### From Single-AZ to Multi-AZ

⭐ 시험에서는 RDS가 Single-AZ에서 Multi-AZ로 전환될 수 있는지에 대한 질문이 나올 수 있음

- 이 작업에는 downtime이 전혀 없음
  - DB를 중지할 필요가 없음
- 그냥 "modify"를 클릭하고 Multi AZ를 활성화하면 됨
- 내부적인 작동
  - RDS가 자동으로 snapshot 생성
  - 이 스냅샷은 다른 AZ의 새로운 standby DB에 복원됨
  - 두 DB 간의 동기화

<br>

## RDS Security - Encryption

- At rest encryption
  - AES-256 비트 암호화를 사용하는 AWS KMS로 master DB와 read replicas를 암호화할 수 있음
  - 암호화 실행시 실행 시간을 정의해야 함
  - master DB를 암호화하지 않으면 복제본도 암호화할 수 없음 (시험 출제!)
  - Oracle과 SQL Server에서 TDE(Transparent Data Encryption) 활성화 가능
- In-flight encryption
  - 늘 SSL 인증서가 필요한 in flight 암호화
  - DB 연결시 신뢰할 수 있는 인증서로 SSL 옵션을 제공하면 SSL 연결 가능
  - SSL 사용을 강요하기 위해
    - PostgreSQL: `rds.force_ssl=1` 인 Parameter Groups를 AWS RDS 콘솔에서 설정해야 함
    - MySQL: `GRANT USAGE ON *.* TO 'mysqluser'@'%' REQUIRE SSL` 명령문을 DB 내부에서 실행

### RDS Encyption Operations

- RDS 백업 암호화
  - 암호화되지 않은 RDS DB에서 스냅샷 생성시 스냅샷은 암호화되지 않음
  - 마찬가지로 암호화된 RDS DB에서 스냅샷 생성시 스냅샷이 암호화되지만 기본값은 아님
  - 암호화되지 않은 스냅샷을 암호화된 스냅샷으로 복제할 수 있음
- 암호화되지 않은 RDS DB 암호화
  - DB의 스냅샷을 만듦 (이 스냅샷은 암호화되어 있지 않음)
  - 스냅샷을 복제해서 복제한 스냅샷에 암호화 활성화
  - 암호화된 스냅샷에서 DB 복원
  - 이전의 암호화되지 않은 RDS DB를 암호화된 새 RDS DB로 이전
  - 이전 RDS DB 삭제

### Network & IAM

- Network Security
  - RDS DB는 대개 public subnet이 아닌 private subnet에서 배포됨
  - RDS 보안은 RDS 인스턴스에 연결되어 있는 보안 그룹을 활용해서 활성화
    - EC2 인스턴스와 동일한 개념
    - RDS와 통신할 수 있는 IP 또는 보안 그룹 제어
- Access Management
  - IAM policies는 AWS RDS를 관리하는 사람만 제어 가능
  - 기존 방식: Username과 Passwork 사용
  - RDS MySQL과 PostgreSQL은 IAM 기반 인증 사용 가능
- 결국 RDS DB 보안은 주로 DB 안에서 이루어짐

### IAM Authentication

- 오직 MySQL, PostgreSQL에서만 실행됨
- 암호는 필요 없고 인증 토큰 필요
  - 인증 토큰은 RDS API를 호출해서 IAM으로 직접 얻을 수 있음
- 인증 토큰은 수명이 짧음 (15분)
- 이점
  - Network in/out이 SSL로 암호화됨
  - IAM DB 내부에서의 사용자 관리 대신 중앙에서 사용자 관리
  - IAM 역할과 EC2 인스턴스 profile로 쉽게 통합 가능

### RDS Security - Summary

- Encryption at rest
  - DB 인스턴스 최소 생성시 실행
  - 암호화되지 않았다면 스냅샷 생성 필요 → 스냅샷 복제 후 암호화 → 암호화된 스냅샷에서 새 DB 생성
- Your responsibility
  - 모든 port / IP / security group / inbound rule
  - 내부 DB의 모든 사용자 생성 및 권한 관리 / IAM을 활용한 MySQL, PostgreSQL 관리
  - public access가 있거나 없는 DB를 생성해서 public subnet이나 private subnet으로 가게 해야 함
  - Parameter Group과 DB가 SSL 연결만 허용하도록 구성해서 암호화되는지 확인해야 함
- AWS responsibility
  - SSH access 발생 금지
  - 수동 DB 패치 또는 OS 패치
  - 기본 인스턴스를 확인하지 않아도 되게끔 하기
