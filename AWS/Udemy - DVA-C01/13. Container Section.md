## Docker

### What is Docker?

- 앱 배포를 위한 소프트웨어 개발 플랫폼
- 앱들은 패키징되며, **containers**는 표준화되어 있어서 모든 OS에서 실행 가능
  - 앱이 패키징되면 어떤 운영체제에서도 같은 방식으로 실행된다는 뜻
  - any machine
  - no compatibility issues
  - predictable behavior
  - less work
  - easier to maintain and deploy
  - works with any language, any OS, any technology
- Use cases
  - microservices architecture
  - life-and-shift app from on-premises to the AWS cloud

### Where are Docker images stored?

Docker Repositories

- [Docker Hub](https://hub.docker.com)
  - **public** repository
  - 수많은 기술들에 대응하는 기본 이미지들을 찾을 수 있음
- Amazon ECR (Amazon Elastic Container Registry)
  - **private** repository
  - **public** repository - [Amazon ECR Public Gallery](https://gallery.ecr.aws)

### Docker vs Virtual Machines

- Docker 역시 가상화 기술의 "일종"이지만, 온전한 가상화 기술은 아님
  - 리소스들은 호스트와 공유됨 ⇒ 다수의 컨테이너를 하나의 서버에

### Docker Containers Management on AWS

- **Amazon Elastic Container Service (Amazon ECS)**
  - Amazon's own container platform
- **Amazon Elastic Kubernetes Service (Amazon EKS)**
  - Amazon's managed Kubernetes (open source)
- **AWS Fargate**
  - Amazon's own Serverless container platform
  - Works with ECS and with EKS
- **Amazon ECR**
  - Store container images

<br>

## Amazon ECS

_Elastic Container Service_

### EC2 Launch Type

- AWS에서 컨테이너를 실행하는 것 = ECS 클러스터에서 **ECS Tasks**를 실행하는 것
- **EC2 Launch Type** : 반드시 인프라를 provision하고 유지해야 함
  - **the EC2 instances**
- 각각의 EC2 instance는 반드시 ECS Agent를 싱행해서 지정된 ECS Cluster에 등록해야 함
- AWS는 컨테이너 실행 및 중지를 관리해줌

### Fargate Launch Type

- 마찬가지로 AWS에서 Docker 컨테이너를 실행
- 인프라를 provision하지 않음
  - **no EC2 instances to manage**
- **It's all Serverless**
- 단지 task definitions만 생성하면 됨
- AWS는 그저 필요한 CPU 및 RAM에 따라 ECS Tasks를 대신 실행해줌
- 확장할 때는 간단하게 task 수만 늘리면 됨

※ 시험에서 Fargate를 사용하라는 문제가 자주 출제 (EC2 Launch Type보다 관리가 쉬워서)

### IAM Roles for ECS

**EC2 Instance Profile (EC2 Launch Type only)**

- **ECS Agent**가 다음 용도를 위해 EC2 Instance Profile을 사용
  - ECS 서비스를 위한 API 호출을 만들어냄
  - instance가 저장된 ECS 서비스는 CloudWatch Logs API 호출
  - ECR로부터 Dokcer image를 가져옴
  - Secrets Manager, SSM Parameter Store에서 민감한 데이터를 참조

**ECS Task Role**

- 각 task마다 특정 role을 부여할 수 있음
- 각 역할은 저마다 다른 ECS 서비스에 연결할 수 있게 함
- **task definition**에서 task role 정의

### Load Balancer Integrations

- **Application Load Balancer** : 대부분의 사용 사례를 지원
- **Network Load Balancer** : 처리량이 많거나 높은 성능이 요구될 때 사용할 것을 권장
  - AWS Private Link와 함께 사용할 때 좋음
- **Elastic Load Balancer** : 오래된 세대의 ELB는 지원되기는 하지만 권장되지 않음
  - 고급 기능이 없고, Fargate와 연결할 수 없음

### Data Volumes (EFS)

- ECS task의 파일 시스템을 위해 EFS를 mount할 수 있음
- EC2와 Fargate 모두 사용 가능
- 어떤 AZ에서 실행되는 task라도 Amazon EFS에 연결되어 있다면 데이터를 공유할 수 있음
- **Fargate + EFS = Serverless**
  - Fargate를 통해 Serverless 방식으로 ECS task를 실행하고, 파일 시스템 지속성을 위해 Amazon EFS 사용
- Use cases: EFS와 ECS를 함께 사용해서 multi-AZ가 공유하는 컨테이너의 영구 스토리지
- Note
  - 현재 ECS는 Lustre용 FSx를 지원하지 않음
  - ECS task의 파일 시스템으로 Amazon S3 버켓을 mount할 수 없음

### Auto Sacling

- ECS task를 자동으로 늘리거나 줄일 수 있음
- **AWS Application Auto Scaling**
  - ECS CPU 사용률 확장
  - ECS 메모리 사용률 확장
  - ALB 타겟당 요청 횟수 확장 (ALB 관련 지표)
- **Target Tracking**
  - CloudWatch의 특정 지표에 따라 스케일링
- **Step Scaling**
  - CloudWatch Alarm을 기반으로 스케일링
- **Scheduled Scaling**
  - 특정 날짜 및 시간에 스케일링
- ECS Service Auto Scaling(task level) ≠ EC2 Auto Scaling(EC2 instance level)
- EC2 instance가 없다면 Fargate Auto Scaling이 훨씬 쉬울 것

#### EC2 Launch Type - Auto Scaling EC2 Instances

- **Auto Scaling Group Scaling**
  - CPU 사용률 등에 따라 ASG 스케일링
- **ECS Cluster Capacity Provider** (recommended)
  - 새 task를 실행할 용량이 부족하면 자동으로 ASG 확장
  - Auto Scaling Group과 함께 사용됨
  - CPU나 RAM이 부족할 때 EC2 instance 추가

### Rolling Updates

- v1에서 v2로 업데이트할 때, 얼마나 많은 task들이 시작되고 중단될지 제어 가능
- Minimum health percent와 Maximum percent를 조정
  - Minimum health percent에 따라 최소 v1을 남겨두고 진행
  - Maximum percent가 100을 넘어서면 그만큼 확장한 다음에 업데이트하고, 다시 100%로 돌아옴

※ 이 내용을 다루는 문제는 하나 이상 나오진 않을 것
