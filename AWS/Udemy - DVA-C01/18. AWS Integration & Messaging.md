- 트래픽이 급증하거나, 동영상 인코딩 같은 무거운 작업을 하거나, 예측이 어려운 경우 애플리케이션을 **decouple**해야 함
- 분리 계층의 확장
  - SQS: queue model
  - SNS: pub/sub model
  - Kinesis: real-time streaming model
- 이 서비스들은 독립적으로 서비스를 확장할 수 있음

<br>

## Amazon SQS

### What's a queue?

- SQS Queue는 메시지를 포함
- 메시지를 담기 위해서 SQS Queue에 메시지를 전송하는 주체가 **Producer**
  - 여러 생산자가 여러 메시지를 SQS Queue로 보내도록 할 수 있음
- 메시지는 무엇이든 상관없음
- Queue에서 메시지를 처리하고 수신해야 하는 대상이 **Consumer**
  - 소비자는 Queue로부터 메시지를 폴링
  - 메시지를 처리하고, Queue에서 해당 메시지 삭제
- Queueing 서비스는 생산자와 소비자를 분리하는 buffer 역할 수행

### Standard Queue

- AWS의 가장 오래된 서비스 (10년이 넘어감)
- fully managed service, used to decouple applications
- 특성
  - 무제한 처리량을 얻을 수 있음!
    - 초당 원하는 만큼 메시지를 보낼 수 있고 queue에도 원하는 만큼 메시지를 포함시킬 수 있음
  - 각 메시지는 기본 4일에서 최대 14일까지 유지 가능
  - low latency
    - 메시지를 보내거나 받을 때 10ms 내에 응답을 받을 수 있음
  - 각 메시지는 256KB 미만이어야 함
- 중복된 메시지가 있을 수 있음 (at least once delivery)
- out of order 메시지가 있을 수 있음 (best effor ordering)

### Producing Messages

- 생산자는 SDK SendMessage API를 호출해서 SQS를 사용할 것
- 소비자가 해당 메시지를 읽고 삭제할 때까지 SQS에 유지됨
- 메시지 유지 기간: 4일 ~ 14일

### Consuming Messages

- 소비자에 해당할 수 있는 것들: EC2 인스턴스, 서버들, AWS Lambda 등
- 소비자는 SQS 메시지를 폴링 (한 번에 최대 10개까지 받을 수 있음)
- 메시지 처리
  - ex) 메시지 내용을 RDS DB에 저장
- DeleteMessage API를 호출해서 메시지 삭제

### Multiple EC2 Instances Consumers

- 메시지를 수신하고 처리할 소비자를 여럿 가질 수 있음
- ex) SQS 메시지 처리를 위해 3개의 EC2 인스턴스를 두는 경우
- 만일 메시지가 소비자에 의해 충분히 빠르게 처리되지 않으면 다른 소비자가 수신
  - 그렇기 때문에 **at least once delivery**라고 하는 것!
  - 또한 이 때문에 **best-effort message ordering**을 수행하는 것
- 소비자가 메시지 처리 이후 삭제를 해줘야 다른 소비자가 같은 메시지를 보지 않게 할 수 있음
- 소비자를 추가하는 수평 확장을 통해 처리량 개선
  - ASG가 수평 확장을 할 수 있도록 SQS의 ApproximateNumberOfMessages 지표를 활용할 수 있을 것

### Security

- **Encryption**
  - HTTPS API를 활용한 in-flight 암호화
  - KMS 키를 사용하여 at-rest 암호화
  - 원한다면 client-side 암호화도 가능 (SQS 기본 지원은 아님)
- **Access Controls**
  - SQS API 액세스 제어를 위한 IAM policy
- **SQS Access Policies**
  - S3 bucket policy와 유사
  - SQS Queue에 대한 cross-account access를 수행해야 할 때
  - SNS, S3 등 다른 서비스에서 SQS Queue write 권한을 줄 때
