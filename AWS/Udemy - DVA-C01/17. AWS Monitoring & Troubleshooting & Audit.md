## Why Monitoring is Important

- 사용자들은 애플리케이션이 작동하는지만 본다!
  - Application latency
  - Application outages
- Internal monitoring
  - 이슈가 발생하기 전에 이를 방지할 수 있는가?
  - 성능과 비용
  - Trends (scaling patterns)

<br>

## Monitoring in AWS

**AWS CloudWatch**

- Metrics: key metric 수집
- Logs: 로그 파일을 수집하고, 모니터링하고, 분석하고, 저장
- Events: 특정 이벤트가 발생했을 때 알림 전송
- Alarms: 실시간 metrics / events에 반응해서 알람 전송

**AWS X-Ray**

- 애플리케이션 성능과 에러에 대한 troubleshooting 수행
- 마이크로서비스 분산 추적 작업 가능

**AWS CloudTrail**

- API 호출을 통해 내부 모니터링 수행
- 리소스 변경에 대한 audit 수행

<br>

## CloudWatch

### Metrics

- AWS의 모든 서비스에 대한 metrics 제공
- **metric**은 보통 그 이름을 보고도 뭔지 알 수 있음
  - CPUUtilization, NetworkIn, etc
- metrics는 **namespaces**에 속함
- **Dimension** : attribute of a metric
  - instance id, environment, etc
  - metric 당 최대 10개 dimensions
- metric은 **timestamps**를 가짐
- Can create CloudWatch dashboards of metrics

### EC2 Detailed monitoring

- EC2 인스턴스는 기본적으로 "매 5분마다" metric을 가짐
- 추가 비용이 드는 detailed monitoring을 활성화하면 "매 1분마다" 얻을 수 있음
- 이를 활성화하면 ASG가 더욱 빠르게 반응할 수 있음!
- AWS Free Tier의 경우 최대 10개의 detailed monitoring metrics를 확보할 수 있음

※ Note: EC2 메모리 사용량은 기본 push가 안되고, custom metric으로서 push되어야 함

### Custom Metrics

- CloudWatch에서 나만의 custom metric 정의 가능
- ex) memory usage, disk space, number of logged, etc
- 이를 사용하기 위해 **PutMetricData** API 호출
- Ability to use dimensions(attributes) to segment metrics
  - Instance.id
  - Evironment.name
- Metric resolution
  - **StorageResolution** API parameter를 이용해서 2가지 값을 지정할 수 있음
  - Standard: 1분에 한번씩 push하는 custom metric의 경우
  - High Resolution: 1/5/10/30초에 한번씩 push하는 경우 (Higher cost)
- ⭐ data point를 push하는 방향이 과거든 미래든 상관 없음
  - 따라서 metrics를 AWS 실제 시간과 동기화하려면 EC2 인스턴스 시간이 현재로 구성되어 있는지 확인해야 함

## CloudWatch Logs

- **Log groups** : 로그를 로그 그룹으로 나누어서 이름 지정 - 보통은 애플리케이션을 나타냄
- **Log stream** : 각 로그 그룹 내에는 로그 스트림이 존재
  - instances within application / log files / containers
- 로그 만료 정책을 정의할 수 있음
  - never expire, 30 days, etc
- **CloudWatch Logs can send logs to**
  - Amazon S3 (exports)
  - Kinesis Data Streams
  - Kinesis Data Firehose
  - AWS Lambda
  - ElasticSearch

### Sources (로그 전송 유형)

- SDK, CloudWatch Logs Agent, CloudWatch Unified Agent
  - CloudWatch Unified Agent는 CloudWatch에 로그를 전송하므로 더이상 사용되지 않음
- Elastic Beanstalk: 애플리케이션에서 CloudWatch로 직접 로그 수집
- ECS: 컨테이너에서 바로 CloudWatch로 로그 전송
- AWS Lambda: 함수 자체에서 로그 전송
- VPC Flow Logs: VPC에서 특정된 로그들 전송
- API Gateway: 들어온 모든 요청을 CloudWatch Logs에 전달
- CloudTrail based on filter
- Rout53: 모든 DNS 쿼리들을 로그로 남김

### Logs Metric Filter & Insights

- CloudWatch Logs can use filter expressions
  - ex1) 로그 내 모든 특정 IP를 찾아낼 수 있음
  - ex2) 로그 내 "ERROR"라는 단어가 포함된 모든 로그 라인을 찾아낼 수 있음
- metric filters에 해당하는 지표는 CloudWatch Ararms와 연결됨
- CloudWatch Logs Insights 기능은 로그를 쿼리하고, 이 쿼리를 CloudWatch Dashboards에 추가할 수 있게 해줌
- **Filter는 이전 필터 데이터를 적용하지 않고, 생성된 이후에 발생하는 이벤트에 대한 metric data만을 publish**

### S3 Export

- export에 **최대 12시간까지** 소요할 수 있음
- **CreateExportTask** API 호출
- 실시간이 아님 → CloudWatch Logs에서 로그를 스트리밍하려면 Logs Subscriptions를 사용해야 함

### Logs for EC2

- 기본적으로, EC2 인스턴스에서 CloudWatch로 로그를 전송할 수 없음
- EC2 로그 파일을 push하는 작은 프로그램인 CloudWatch agent를 실행해야 함
- 관련 IAM permissions가 정확한지 체크해야 함
- CloudWatch log agent는 on-premise 서버에도 설치 가능

### Logs Agent & Unified Agent

- for virtual servers
- **CloudWatch Logs Agent**
  - 구버전 agent
  - CloudWatch Logs만 전송 가능
- **CloudWatch Unified Agent**
  - 추가적으로 system-level metrics 수집 가능 (RAM, processes, etc)
  - CloudWatch Logs 전송
  - SSM Parameter Store를 사용하므로 agent 구성에 용이

#### Unified Agent - Metrics

- EC2 인스턴스나 Linux 서버에 설치하면 metrics를 수집
- **CPU** (active, guest, idle, system, user, steal)
- **Disk metrics** (free, used, total) / **Disk IO** (writes, reads, bytes, iops)
- **RAM** (free, inactive, used, total, cached)
- **Netstat** (number of TCP and UDP connections, net packets, bytes)
- **Processes** (total, dead, bloqued, idle, running, sleep)
- **Swap Space** (free, used, used %)
