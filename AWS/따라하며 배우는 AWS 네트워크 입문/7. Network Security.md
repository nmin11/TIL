# Security Group and Network ACL

## Access Control

- 위협으로부터 제반 시설 및 환경을 보호하기 위한 보안 대책
- 인가된 대상에게만 접근을 허용함으로써 보안 강화
- 인증 과정에서 정책에 따라 허용, 거부, 제한적 허용 등의 권한 부여
- 식별할 수 있는 대상들: IP 주소, 프로토콜, 포트 번호

![network-access-control](https://github.com/nmin11/TIL/assets/75058239/01e1094e-ecf0-4ec8-85c5-52d5cedfc6ef)

## Security Group and Network ACL

### Summary

- 둘은 네트워크 인프라 보호를 위한 트래픽 제어 정책
- IP 주소, 프로토콜, 포트 번호를 통해 대상을 식별하고 제어 정책에 따라 허용 여부 판단
- 트래픽의 방향성에 따라 Inbound Rule과 Outbound Rule로 나뉨

![security-group-and-network-acl](https://github.com/nmin11/TIL/assets/75058239/7866cefb-4b40-4096-a58a-a41dc33007f4)

### Difference between Security Group and Network ACL

**Traffic control targets**

- Security Group: 인스턴스 레벨의 접근 제어 정책 (EC2 인스턴스, ALB 등)
- Network ACL: 서브넷 레벨의 접근 제어

**Stateful vs Stateless**

- Security Group
  - stateful
  - inbound 트래픽이 허용되면 outboud는 규칙에 상관없이 허용
- Network ACL
  - stateless
  - inbound 트래픽이 허용되어도 outbound는 규칙에 따라 허용 여부를 다시 결정해야 함

**Allow/Deny rule**

- Security Group
  - allow 규칙만 나열하며, 아닌 것들은 자동으로 deny가 됨
- Network ACL
  - allow/deny 규칙이 둘 다 존재
  - 규칙 순서를 확인하기 위한 sequence number가 있으며, 작은 숫자부터 순차적으로 확인
    - 확인하다가 허용되는 대상이 있으면 하위 규칙을 더 확인하지 않음

<br>

# VPC Flow Log

## Introduce

- VPC에 속한 ENI에서 송수신되는 트래픽에 대한 정보를 수집할 수 있는 기능
- 네트워크 연결 문제, 보안 문제, 네트워크 접근 제어 정책 정상 동작 여부를 확인할 수 있음
- 특정 유형의 트래픽을 감지하는 알람을 만들거나, 트래픽 변화 및 패턴을 파악하는 통계 지표를 만들 수 있음

![vpc-flow-log-example](https://github.com/nmin11/TIL/assets/75058239/63fc50d4-00b2-4ee3-b6bc-9f5b52ccfb80)

- EC2 인스턴스의 ENI에 구성하거나, subnet의 ENI에 구성할 수 있음
- VPC Flow Log 생성 후 데이터 수집 및 로그 레코드 게시까지 1분 또는 10분의 대기 시간이 소요됨
  - ENI에 대한 로그 정보를 실시간으로 게시하지는 않는다는 뜻

## Record structure

- VPC에서 Flow Log를 활성화하면 대상 ENI로 송수신되는 정보를 수집하는데, 이 정보 형태를 _Flow Log Record_ 라고 부름

**Flow Log Record default type**

```
<ver><acco-id><inf-id><srcaddr><dstaddr><srcport><dstport><prot><pkts><bytes><start><end><act><log-stat>
```

**Flow Log Record fields**

|  Record  |      Full form      | Meaning                              |
| :------: | :-----------------: | :----------------------------------- |
|   ver    |       Version       | VPC Flow Log 버전, default = 2       |
| acco-id  |     Account-ID      | 소스 ENI 소유자의 AWS account ID     |
|  inf-id  |    Interface-ID     | 기록하는 ENI의 ID                    |
| srcaddr  |   Source Address    | 출발지 IP 주소 정보                  |
| dstaddr  | Destination Address | 목적지 IP 주소 정보                  |
| srcport  |     Source Port     | 출발지 포트 번호                     |
| dstport  |  Destination Port   | 목적지 포트 번호                     |
|   prot   |      Protocol       | 대상 프로토콜 정보                   |
|   pkts   |       Packets       | 전송된 패킷 수                       |
|  bytes   |          -          | 전송된 byte 크기                     |
|  start   |          -          | 첫번째 패킷이 집계된 시간            |
|   end    |          -          | 마지막 패킷이 집계된 시간            |
|   act    |       Action        | 패킷에 대한 Accept 및 Reject 구분    |
| log-stat |     Log Status      | Flow Log 상태 (OK, NODATA, SKIPDATA) |

<br>

# VPC Traffic Mirroring

## Introduce

- 네트워크 환경에서 발생하는 트래픽을 복제 및 특정 장치로 전달해서 해당 트래픽 정보를 모니터링하는 기능
- 클라우드가 아닌 기존 네트워크 환경에서는 TAP(Test Access Point) 장치로 미러링하거나,<br>네트워크 장비 자체가 특정 포트로 미러링하는 기능을 수행
- AWS는 클라우드 네트워크에서도 이를 유사하게 지원
- VPC Flow Log와도 유사해 보이지만 아래의 요소들이 다름

![vpc-flow-log-vs-vpc-traffic-mirroring](https://github.com/nmin11/TIL/assets/75058239/0ae14ab2-0f0d-4e42-b270-4753c3ca4397)

- 트래픽 상세 분석이나 기반 자료의 결과를 확인하고 싶은 경우에 사용

## Features

**Mirror Source**

- 트래픽 미러링을 수행할 대상
- VPC 내 존재하는 AWS 네트워크 리소스를 대상으로 함
- ENI를 미러 소스로 사용 가능

**Mirror Target**

- 트래픽 미러링을 통해 복제된 트래픽을 전달할 목적지
- 대상은 소스와 다른 ENI 또는 NLB가 될 수 있음
  - 소스와 타깃이 동일한 대상일 수는 없음

**Mirror Filter**

- 트래픽 미러링 필터를 통해 트래픽 대상 정의
- 출발지/목적지의 IP, 프로토콜, 포트 번호 등을 필터링 대상으로 지정 가능
- inbound 또는 outbound 형태
- 이 내용이 존재하지 않으면 대상이 없다는 의미라서 트래픽 미러링을 수행하지 않음!

**Mirror Session**

- 트래픽 미러링 필터를 사용하는 미러 소스와 미러 타겟 간의 연결을 뜻하는 단위
- 소스와 타겟을 지정하고 필터를 연결해서 트래픽 미러링 연결 구성을 생성

## Flow

`Select a Mirror Target → Compose a Mirror Filter → Create a Mirror Session`

![vpc-traffic-mirroring-flow](https://github.com/nmin11/TIL/assets/75058239/d1932e08-5579-4222-9206-744a821fb173)

1. 복제된 트래픽을 전달받게 될 미러 타겟 지정
2. 미러 필터 구성
3. 미러 세션 생성
4. 트래픽 발생 시 미러 필터에서 일치 여부 판별
5. 매칭된 트래픽을 복제해서 미러 타겟에게 전달, 트래픽은 VXLAN 터널링에 의해 보호됨

※ VXLAN

_Virtual Extensible Local Area Network_
= 원본 데이터를 송수신할 때 VXLAN 헤더 정보를 감싸서 전달하는 터널링 방법

※ VPC Traffic Mirroring을 통해 전달받은 패킷 예시

![vpc-traffic-mirroring-packet-example](https://github.com/nmin11/TIL/assets/75058239/03c9fc96-8409-4d14-a29b-ce445246c639)

## Constraints

**EC2 instance type**

- Nitro 타입만 지원

**Location of Mirror Source and Mirror Target**

- 동일한 VPC에 있거나, 다른 VPC라면 VPC 피어링이나 Transit G/W 필요

**Number of Mirror Sessions**

- 계정당 1,000개
- ENI 당 3개

**Protocol of traffic**

- ARP, DHCP, NTP, EC2 metadata 등에 대해서 트래픽 미러링 수행 불가
